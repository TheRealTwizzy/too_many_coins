<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Too Many Coins â€” Admin Economy</title>
	<style>
	body {
		font-family: system-ui, sans-serif;
		background: #0f1220;
		color: #eaeaf0;
		padding: 2rem;
		max-width: 960px;
		margin: 0 auto;
	}
	a { color: #c5cae9; text-decoration: none; }
	.card {
		border: 1px solid #2a2f55;
		padding: 1rem;
		margin-bottom: 1rem;
		border-radius: 10px;
		background: #141a2e;
	}
	.label { font-size: 0.8rem; color: #aaa; }
	.row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
	input[type="range"] { width: 240px; }
	button { background: #0f1220; border: 1px solid #2a2f55; color: #eaeaf0; padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; }
	button.primary { background: #3b82f6; border-color: #3b82f6; }
	</style>
</head>
<body>
	<h1>Economy Controls</h1>
	<p class="label"><a href="/admin.html">Admin home</a></p>

	<div class="card">
		<div class="label">Admin key</div>
		<input id="admin-key" placeholder="Enter admin key" />
		<button id="save-key">Save</button>
		<div id="key-status" class="label"></div>
	</div>

	<div class="card" id="no-access" style="display:none;">
		<div class="label">Not authorized</div>
	</div>

	<div class="card">
		<div class="label">Daily emission target</div>
		<div class="row">
			<input id="emission" type="range" min="0" max="5000" step="50" />
			<span id="emission-value"></span>
		</div>
		<div class="row" style="margin-top:0.5rem;">
			<label><input type="checkbox" id="faucets" /> Faucets enabled</label>
			<label><input type="checkbox" id="sinks" /> Sinks enabled</label>
			<label><input type="checkbox" id="telemetry" /> Telemetry enabled</label>
		</div>
		<div class="row" style="margin-top:0.5rem;">
			<button id="save" class="primary">Save</button>
		</div>
		<div id="status" class="label"></div>
	</div>

	<script>
	function getAdminKey() {
		return localStorage.getItem("adminKey") || "";
	}

	async function apiFetch(url, options = {}) {
		return fetch(url, {
			...options,
			headers: {
				"Content-Type": "application/json",
				"X-Admin-Key": getAdminKey(),
				...(options.headers || {})
			}
		});
	}

	async function loadAccess() {
		const res = await apiFetch("/auth/me");
		const data = await res.json();
		if (!data.ok || !data.isAdmin) {
			document.getElementById("no-access").style.display = "block";
			return false;
		}
		return true;
	}

	async function loadEconomy() {
		const res = await apiFetch("/admin/economy");
		const data = await res.json();
		if (!data.ok) {
			document.getElementById("status").innerText = "Unauthorized.";
			return;
		}
		const emission = document.getElementById("emission");
		emission.value = data.dailyEmissionTarget || 0;
		document.getElementById("emission-value").innerText = emission.value;
		document.getElementById("faucets").checked = !!data.faucetsEnabled;
		document.getElementById("sinks").checked = !!data.sinksEnabled;
		document.getElementById("telemetry").checked = !!data.telemetryEnabled;
	}

	document.getElementById("emission").addEventListener("input", (e) => {
		document.getElementById("emission-value").innerText = e.target.value;
	});

	document.getElementById("save").addEventListener("click", async () => {
		const payload = {
			dailyEmissionTarget: parseInt(document.getElementById("emission").value, 10),
			faucetsEnabled: document.getElementById("faucets").checked,
			sinksEnabled: document.getElementById("sinks").checked,
			telemetryEnabled: document.getElementById("telemetry").checked
		};
		const res = await apiFetch("/admin/economy", {
			method: "POST",
			body: JSON.stringify(payload)
		});
		const data = await res.json();
		if (!data.ok) {
			document.getElementById("status").innerText = data.error || "Save failed";
			return;
		}
		document.getElementById("status").innerText = "Saved.";
		loadEconomy();
	});

	document.getElementById("save-key").addEventListener("click", () => {
		const key = document.getElementById("admin-key").value.trim();
		localStorage.setItem("adminKey", key);
		document.getElementById("key-status").innerText = key ? "Key saved." : "Key cleared.";
		loadEconomy();
	});

	const storedKey = getAdminKey();
	if (storedKey) {
		document.getElementById("admin-key").value = storedKey;
		document.getElementById("key-status").innerText = "Key loaded.";
	}

	loadAccess().then((ok) => {
		if (ok) {
			loadEconomy();
		}
	});
	</script>
</body>
</html>
