<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Too Many Coins â€” Moderator</title>
	<style>
	body {
		font-family: system-ui, sans-serif;
		background: #0f1220;
		color: #eaeaf0;
		padding: 2rem;
		max-width: 960px;
		margin: 0 auto;
	}
	a { color: #c5cae9; text-decoration: none; }
	.card {
		border: 1px solid #2a2f55;
		padding: 1rem;
		margin-bottom: 1rem;
		border-radius: 10px;
		background: #141a2e;
	}
	.label { font-size: 0.8rem; color: #aaa; }
	.row { display: flex; gap: 1rem; flex-wrap: wrap; }
	input, button {
		background: #0f1220;
		border: 1px solid #2a2f55;
		color: #eaeaf0;
		padding: 0.5rem 0.75rem;
		border-radius: 8px;
	}
	button { cursor: pointer; }
	button.primary { background: #3b82f6; border-color: #3b82f6; }
	</style>
</head>
<body>
	<h1>Moderator</h1>
	<p class="label">Profile moderation tools.</p>
	<p><a href="/">Back to game</a></p>

	<div class="card">
		<div class="label">Local admin key</div>
		<div class="row" style="margin-top:0.5rem;">
			<input id="local-key" placeholder="Admin key" />
			<button id="save-local-key" class="primary">Save</button>
		</div>
		<div id="local-key-status" class="label"></div>
	</div>

	<div class="card" id="moderator-content" style="display:none;">
		<div class="label">Edit profile</div>
		<div class="row" style="margin-top:0.5rem;">
			<input id="mod-username" placeholder="Username" />
			<button id="mod-load" class="primary">Load</button>
		</div>
		<div class="row" style="margin-top:0.5rem;">
			<input id="mod-display-name" placeholder="Display name" />
			<button id="mod-save" class="primary">Update</button>
		</div>
		<div id="mod-status" class="label"></div>
	</div>

	<div class="card" id="no-access" style="display:none;">
		<div class="label">Not authorized</div>
		<div class="label">You need a moderator or admin account to view this page.</div>
	</div>

	<script>
	function getAdminKey() {
		return localStorage.getItem("adminKey") || "";
	}

	async function apiFetch(url, options = {}) {
		return fetch(url, {
			...options,
			headers: {
				"Content-Type": "application/json",
				"X-Admin-Key": getAdminKey(),
				...(options.headers || {})
			},
			credentials: "include"
		});
	}

	async function loadAccess() {
		const res = await apiFetch("/auth/me");
		const data = await res.json();
		if (!data.ok || (!data.isModerator && !data.isAdmin)) {
			document.getElementById("no-access").style.display = "block";
			return false;
		}
		document.getElementById("moderator-content").style.display = "block";
		return true;
	}

	document.getElementById("save-local-key").addEventListener("click", () => {
		const key = document.getElementById("local-key").value.trim();
		if (!key) return;
		localStorage.setItem("adminKey", key);
		document.getElementById("local-key-status").innerText = "Key saved locally.";
	});

	document.getElementById("mod-load").addEventListener("click", async () => {
		const username = document.getElementById("mod-username").value.trim();
		const res = await apiFetch(`/moderator/profile?username=${encodeURIComponent(username)}`);
		const data = await res.json();
		if (!data.ok) {
			document.getElementById("mod-status").innerText = data.error || "Load failed.";
			return;
		}
		document.getElementById("mod-display-name").value = data.displayName || "";
		document.getElementById("mod-status").innerText = "Profile loaded.";
	});

	document.getElementById("mod-save").addEventListener("click", async () => {
		const username = document.getElementById("mod-username").value.trim();
		const displayName = document.getElementById("mod-display-name").value.trim();
		const res = await apiFetch("/moderator/profile", {
			method: "POST",
			body: JSON.stringify({ username, displayName })
		});
		const data = await res.json();
		document.getElementById("mod-status").innerText = data.ok ? "Profile updated." : (data.error || "Update failed.");
	});

	const storedKey = getAdminKey();
	if (storedKey) {
		document.getElementById("local-key").value = storedKey;
		document.getElementById("local-key-status").innerText = "Key loaded.";
	}

	loadAccess();
	</script>
</body>
</html>
