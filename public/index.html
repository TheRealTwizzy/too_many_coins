<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Too Many Coins</title>
	<style>
	:root {
		color-scheme: dark;
	}
	body {
		font-family: system-ui, sans-serif;
		background: #0f1220;
		color: #eaeaf0;
		padding: 2rem;
		max-width: 960px;
		margin: 0 auto;
	}
	header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 1.5rem;
	}
	.badge {
		font-size: 0.75rem;
		padding: 0.25rem 0.5rem;
		border-radius: 999px;
		background: #1f2544;
		border: 1px solid #2a2f55;
	}
	.badge.accent {
		background: rgba(59, 130, 246, 0.15);
		border-color: rgba(59, 130, 246, 0.5);
		color: #93c5fd;
	}
	nav a {
		color: #c5cae9;
		text-decoration: none;
		margin-left: 0.75rem;
		font-size: 0.85rem;
	}
	.card {
		border: 1px solid #2a2f55;
		padding: 1rem;
		margin-bottom: 1rem;
		border-radius: 10px;
		background: #141a2e;
	}
	.recommended {
		border-color: #ffd166;
		background: rgba(255, 209, 102, 0.08);
	}
	.label {
		font-size: 0.8rem;
		color: #aaa;
	}
	input, textarea, button {
		background: #0f1220;
		border: 1px solid #2a2f55;
		color: #eaeaf0;
		padding: 0.5rem 0.75rem;
		border-radius: 8px;
	}
	button {
		cursor: pointer;
	}
	button.primary {
		background: #3b82f6;
		border-color: #3b82f6;
	}
	.row {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		flex-wrap: wrap;
	}
	.stack {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}
	.toast {
		padding: 0.6rem 0.8rem;
		border-radius: 8px;
		background: #11162b;
		border: 1px solid #2a2f55;
		font-size: 0.85rem;
	}
	.toast.error {
		border-color: #ef4444;
		color: #fecaca;
	}
	.toast.success {
		border-color: #22c55e;
		color: #bbf7d0;
	}
	.muted {
		color: #9aa3c4;
		font-size: 0.8rem;
	}
	.grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
		gap: 1rem;
	}
	</style>
</head>
<body>
	<header>
		<div>
			<h1>Too Many Coins</h1>
			<div class="label">Earn coins, buy stars, climb the season.</div>
		</div>
		<div class="stack" style="align-items:flex-end;">
			<div class="row">
				<span class="badge">ALPHA 1</span>
				<span id="stat-pill" class="badge accent" style="display:none;"></span>
			</div>
			<nav>
				<a href="/about.html">About</a>
				<a href="/playtest.html">Playtest</a>
				<a id="moderator-link" href="/moderator.html" style="display:none;">Moderate</a>
				<a id="admin-link" href="/admin.html" style="display:none;">Admin</a>
			</nav>
		</div>
	</header>

	<div class="card" id="auth-card">
		<div id="auth-status" class="label">Checking session…</div>
		<div id="auth-forms" class="stack">
			<div class="row">
				<input id="username" placeholder="Username" />
				<input id="password" type="password" placeholder="Password" />
			</div>
			<div class="row">
				<button class="primary" id="login-btn">Log in</button>
				<a class="muted" href="/signup.html">Create account</a>
			</div>
			<div class="muted">Alpha accounts are local to this test.</div>
		</div>
		<button id="logout-btn" style="display:none;">Log out</button>
	</div>

	<div id="toast" class="toast" style="display:none;"></div>

	<div class="grid" id="player-panels" style="display:none;">
		<div class="card" id="profile-card">
			<div class="label">Profile</div>
			<div id="profile-name"></div>
			<div id="profile-role" class="label"></div>
			<input id="profile-display" placeholder="Display name" />
			<button id="profile-save">Save</button>
		</div>

		<div class="card" id="player-stats">
			<div class="label">Your stats</div>
			<div id="player-coins" class="label"></div>
			<div id="player-stars" class="label"></div>
		</div>
	</div>

	<div class="card" id="onboarding" style="display:none;">
		<div class="label">Quick start</div>
		<div>Play the current season. Earn coins over time. Spend them on stars.</div>
		<button id="dismiss-hint">Got it</button>
	</div>

	<div class="card" id="feedback-card" style="display:none;">
		<div class="label">Playtest feedback</div>
		<textarea id="feedback-text" rows="3" style="width:100%;"></textarea>
		<button id="feedback-send">Send</button>
	</div>

	<div class="card" id="actions-card" style="display:none;">
		<div class="label">Quick actions</div>
		<div class="row">
			<button id="claim-daily" class="primary">Daily claim</button>
			<button id="claim-activity">Activity claim</button>
			<button id="risk-roll">Risk roll (1)</button>
		</div>
		<div id="actions-status" class="muted"></div>
	</div>

	<div id="locked-message" class="label"></div>
	<div id="seasons" class="grid">Loading season…</div>

	<script>
const authStatus = document.getElementById("auth-status");
const authForms = document.getElementById("auth-forms");
const logoutBtn = document.getElementById("logout-btn");
const profileCard = document.getElementById("profile-card");
const profileName = document.getElementById("profile-name");
const profileRole = document.getElementById("profile-role");
const profileDisplay = document.getElementById("profile-display");
const profileSave = document.getElementById("profile-save");
const playerStats = document.getElementById("player-stats");
const playerPanels = document.getElementById("player-panels");
const coinsDiv = document.getElementById("player-coins");
const starsDiv = document.getElementById("player-stars");
const onboarding = document.getElementById("onboarding");
const feedbackCard = document.getElementById("feedback-card");
const actionsCard = document.getElementById("actions-card");
const actionsStatus = document.getElementById("actions-status");
const toast = document.getElementById("toast");
const statPill = document.getElementById("stat-pill");
const moderatorLink = document.getElementById("moderator-link");
const adminLink = document.getElementById("admin-link");

let joinedSeasonId = localStorage.getItem("joinedSeasonId");
let playerCoins = 0;
let playerStars = 0;
let currentUser = null;
const ALPHA_SEASON_ID = "season-1";

if (joinedSeasonId && joinedSeasonId !== ALPHA_SEASON_ID) {
	localStorage.removeItem("joinedSeasonId");
	joinedSeasonId = null;
}

function apiFetch(url, options = {}) {
	return fetch(url, {
		...options,
		headers: {
			"Content-Type": "application/json",
			...(options.headers || {})
		},
		credentials: "include"
	});
}

async function track(eventType, payload) {
	try {
		await apiFetch("/telemetry", {
			method: "POST",
			body: JSON.stringify({ eventType, payload })
		});
	} catch (e) {}
}

async function loadAuth() {
	const res = await apiFetch("/auth/me");
	const data = await res.json();
	if (!data.ok) {
		currentUser = null;
		authStatus.innerText = "Log in to save your profile.";
		authForms.style.display = "block";
		logoutBtn.style.display = "none";
		playerPanels.style.display = "none";
		feedbackCard.style.display = "none";
		actionsCard.style.display = "none";
		statPill.style.display = "none";
		moderatorLink.style.display = "none";
		adminLink.style.display = "none";
		document.getElementById("seasons").style.display = "none";
		document.getElementById("locked-message").innerText = "Log in to access seasons.";
		return;
	}

	currentUser = data;
	authStatus.innerText = `Logged in as ${data.displayName}`;
	authForms.style.display = "none";
	logoutBtn.style.display = "block";
	profileName.innerText = `@${data.username}`;
	profileRole.innerText = `Role: ${data.role || "user"}`;
	profileDisplay.value = data.displayName;
	playerPanels.style.display = "grid";
	feedbackCard.style.display = "block";
	actionsCard.style.display = "block";
	statPill.style.display = "inline-flex";
	moderatorLink.style.display = (data.isModerator || data.isAdmin) ? "inline" : "none";
	adminLink.style.display = data.isAdmin ? "inline" : "none";
	document.getElementById("seasons").style.display = "grid";
	document.getElementById("locked-message").innerText = "";
}

async function refreshPlayer() {
	if (!currentUser) return;
	const res = await apiFetch("/player");
	if (res.status === 401) return;
	const data = await res.json();
	playerCoins = data.playerCoins || 0;
	playerStars = data.playerStars || 0;
	coinsDiv.innerText = `Coins: ${playerCoins}`;
	starsDiv.innerText = `Stars: ${playerStars}`;
	statPill.innerText = `${playerCoins} coins · ${playerStars} stars`;
}

async function loadSeasons() {
	const res = await fetch("/seasons");
	const data = await res.json();
	const container = document.getElementById("seasons");
	container.innerHTML = "";
	const alphaSeason = data.seasons.find(season => season.seasonId === ALPHA_SEASON_ID);
	if (!alphaSeason) {
		container.innerHTML = "<div class='card'>Season unavailable.</div>";
		return;
	}

	[alphaSeason].forEach(season => {
		const div = document.createElement("div");
		const isJoined = joinedSeasonId !== null;
		const isThisSeasonJoined = season.seasonId === joinedSeasonId;
		const hoursLeft = Math.floor(season.secondsRemaining / 3600);
		const starPrice = season.currentStarPrice;

		div.className = "card";
		if (isJoined && !isThisSeasonJoined) {
			div.style.opacity = "0.5";
		}
		if (season.seasonId === data.recommendedSeasonId) {
			div.classList.add("recommended");
		}

		div.innerHTML = `
			<strong>Season 1</strong>
			<div class="label">Time remaining: ${hoursLeft} hours</div>
			<div class="label">Star price: ${starPrice} coins</div>
			${isThisSeasonJoined
				? `<div class="label">You joined this season</div>
					<button class="buy-star-btn primary">Buy Star</button>`
				: isJoined
					? "<div class='label'>Locked to another season</div>"
					: "<button class='join-btn primary'>Join this season</button>"
			}
		`;

		const buyButton = div.querySelector(".buy-star-btn");
		if (buyButton) {
			buyButton.addEventListener("click", async () => {
				const res = await apiFetch("/buy-star", {
					method: "POST",
					body: JSON.stringify({ seasonId: season.seasonId })
				});
				const data = await res.json();
				if (!data.ok) {
					setToast(data.error || "Purchase failed", "error");
					return;
				}
				playerCoins = data.playerCoins;
				playerStars = data.playerStars;
				coinsDiv.innerText = `Coins: ${playerCoins}`;
				starsDiv.innerText = `Stars: ${playerStars}`;
				statPill.innerText = `${playerCoins} coins · ${playerStars} stars`;
				setToast("Star purchased.", "success");
				track("buy_star", { seasonId: season.seasonId, price: data.starPricePaid });
			});
		}

		const button = div.querySelector(".join-btn");
		if (button) {
			button.addEventListener("click", () => {
				localStorage.setItem("joinedSeasonId", season.seasonId);
				track("join_season", { seasonId: season.seasonId });
				location.reload();
			});
		}

		container.appendChild(div);
	});
}

document.getElementById("login-btn").addEventListener("click", async () => {
	const username = document.getElementById("username").value;
	const password = document.getElementById("password").value;
	const res = await apiFetch("/auth/login", {
		method: "POST",
		body: JSON.stringify({ username, password })
	});
	const data = await res.json();
	if (!data.ok) {
		setToast(data.error || "Login failed", "error");
		return;
	}
	await loadAuth();
	await refreshPlayer();
	track("login", {});
});


logoutBtn.addEventListener("click", async () => {
	await apiFetch("/auth/logout", { method: "POST" });
	currentUser = null;
	await loadAuth();
});

profileSave.addEventListener("click", async () => {
	const displayName = profileDisplay.value;
	const res = await apiFetch("/profile", {
		method: "POST",
		body: JSON.stringify({ displayName })
	});
	const data = await res.json();
	if (!data.ok) {
		setToast(data.error || "Update failed", "error");
		return;
	}
	authStatus.innerText = `Logged in as ${data.displayName}`;
	setToast("Profile updated.", "success");
});

document.getElementById("feedback-send").addEventListener("click", async () => {
	const message = document.getElementById("feedback-text").value.trim();
	if (!message) return;
	await apiFetch("/feedback", {
		method: "POST",
		body: JSON.stringify({ message })
	});
	document.getElementById("feedback-text").value = "";
	setToast("Thanks for the feedback.", "success");
});

document.getElementById("claim-daily").addEventListener("click", async () => {
	const res = await apiFetch("/claim-daily", { method: "POST", body: JSON.stringify({}) });
	const data = await res.json();
	if (!data.ok) {
		actionsStatus.innerText = data.error || "Claim failed";
		setToast(actionsStatus.innerText, "error");
		return;
	}
	actionsStatus.innerText = `Daily claim: +${data.reward} coins`;
	setToast("Daily claim received.", "success");
	await refreshPlayer();
});

document.getElementById("claim-activity").addEventListener("click", async () => {
	const res = await apiFetch("/claim-activity", { method: "POST", body: JSON.stringify({}) });
	const data = await res.json();
	if (!data.ok) {
		actionsStatus.innerText = data.error || "Claim failed";
		setToast(actionsStatus.innerText, "error");
		return;
	}
	actionsStatus.innerText = `Activity claim: +${data.reward} coins`;
	setToast("Activity claim received.", "success");
	await refreshPlayer();
});

document.getElementById("risk-roll").addEventListener("click", async () => {
	const res = await apiFetch("/risk-roll", {
		method: "POST",
		body: JSON.stringify({ wager: 1 })
	});
	const data = await res.json();
	if (!data.ok) {
		actionsStatus.innerText = data.error || "Roll failed";
		setToast(actionsStatus.innerText, "error");
		return;
	}
	actionsStatus.innerText = data.won ? `Won +${data.payout}` : "No win this time";
	setToast("Risk roll complete.", "success");
	await refreshPlayer();
});

document.getElementById("dismiss-hint").addEventListener("click", () => {
	localStorage.setItem("dismissedHint", "true");
	onboarding.style.display = "none";
});

if (localStorage.getItem("dismissedHint") !== "true") {
	onboarding.style.display = "block";
}

function setToast(message, type) {
	toast.innerText = message;
	toast.className = `toast ${type || ""}`;
	toast.style.display = "block";
	setTimeout(() => {
		toast.style.display = "none";
	}, 2500);
}

loadAuth().then(async () => {
	await refreshPlayer();
	if (currentUser) {
		await loadSeasons();
		setInterval(() => {
			refreshPlayer();
		}, 10000);
		setInterval(() => {
			loadSeasons();
		}, 15000);
	}
});
	</script>
</body>
</html>
