<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Too Many Coins</title>
	<style>
	body {
		font-family: system-ui, sans-serif;
		background: #0f1220;
		color: #eaeaf0;
		padding: 2rem;
	}
	.season {
		border: 1px solid #2a2f55;
		padding: 1rem;
		margin-bottom: 1rem;
		border-radius: 8px;
	}
	.recommended {
		border-color: #ffd166;
		background: rgba(255, 209, 102, 0.1);
	}
	.label {
		font-size: 0.8rem;
		color: #aaa;
	}
	</style>
</head>
<body>
	<h1>Too Many Coins</h1>
	<p class="label">Earn coins, buy stars, climb the season.</p>

	<div class="season" id="auth-card">
		<div id="auth-status" class="label">Checking session…</div>
		<div id="auth-forms">
			<input id="username" placeholder="Username" />
			<input id="password" type="password" placeholder="Password" />
			<input id="display-name" placeholder="Display name (signup)" />
			<div style="margin-top: 0.5rem;">
				<button id="login-btn">Log in</button>
				<button id="signup-btn">Sign up</button>
			</div>
		</div>
		<button id="logout-btn" style="display:none;">Log out</button>
	</div>

	<div class="season" id="profile-card" style="display:none;">
		<div class="label">Profile</div>
		<div id="profile-name"></div>
		<input id="profile-display" placeholder="Display name" />
		<button id="profile-save">Save</button>
	</div>

	<div class="season" id="onboarding" style="display:none;">
		<div class="label">Quick start</div>
		<div>Play a season. Earn coins over time. Spend them on stars.</div>
		<button id="dismiss-hint">Got it</button>
	</div>

	<div class="season" id="player-stats" style="display:none;">
		<div id="player-coins" class="label"></div>
		<div id="player-stars" class="label"></div>
	</div>

	<div class="season" id="feedback-card" style="display:none;">
		<div class="label">Playtest feedback</div>
		<textarea id="feedback-text" rows="3" style="width:100%;"></textarea>
		<button id="feedback-send">Send</button>
	</div>

	<div id="seasons">Loading seasons…</div>

	<script>
const authStatus = document.getElementById("auth-status");
const authForms = document.getElementById("auth-forms");
const logoutBtn = document.getElementById("logout-btn");
const profileCard = document.getElementById("profile-card");
const profileName = document.getElementById("profile-name");
const profileDisplay = document.getElementById("profile-display");
const profileSave = document.getElementById("profile-save");
const playerStats = document.getElementById("player-stats");
const coinsDiv = document.getElementById("player-coins");
const starsDiv = document.getElementById("player-stars");
const onboarding = document.getElementById("onboarding");
const feedbackCard = document.getElementById("feedback-card");

const joinedSeasonId = localStorage.getItem("joinedSeasonId");
let playerCoins = 0;
let playerStars = 0;
let currentUser = null;

function apiFetch(url, options = {}) {
	return fetch(url, {
		...options,
		headers: {
			"Content-Type": "application/json",
			...(options.headers || {})
		},
		credentials: "include"
	});
}

async function track(eventType, payload) {
	try {
		await apiFetch("/telemetry", {
			method: "POST",
			body: JSON.stringify({ eventType, payload })
		});
	} catch (e) {}
}

async function loadAuth() {
	const res = await apiFetch("/auth/me");
	const data = await res.json();
	if (!data.ok) {
		currentUser = null;
		authStatus.innerText = "Log in to save your profile.";
		authForms.style.display = "block";
		logoutBtn.style.display = "none";
		profileCard.style.display = "none";
		playerStats.style.display = "none";
		feedbackCard.style.display = "none";
		return;
	}

	currentUser = data;
	authStatus.innerText = `Logged in as ${data.displayName}`;
	authForms.style.display = "none";
	logoutBtn.style.display = "block";
	profileCard.style.display = "block";
	profileName.innerText = `@${data.username}`;
	profileDisplay.value = data.displayName;
	playerStats.style.display = "block";
	feedbackCard.style.display = "block";
}

async function refreshPlayer() {
	if (!currentUser) return;
	const res = await apiFetch("/player");
	if (res.status === 401) return;
	const data = await res.json();
	playerCoins = data.playerCoins || 0;
	playerStars = data.playerStars || 0;
	coinsDiv.innerText = `Coins: ${playerCoins}`;
	starsDiv.innerText = `Stars: ${playerStars}`;
}

async function loadSeasons() {
	const res = await fetch("/seasons");
	const data = await res.json();
	const container = document.getElementById("seasons");
	container.innerHTML = "";

	data.seasons.forEach(season => {
		const div = document.createElement("div");
		const isJoined = joinedSeasonId !== null;
		const isThisSeasonJoined = season.seasonId === joinedSeasonId;
		const hoursLeft = Math.floor(season.secondsRemaining / 3600);
		const starPrice = season.currentStarPrice;

		div.className = "season";
		if (isJoined && !isThisSeasonJoined) {
			div.style.opacity = "0.5";
		}
		if (season.seasonId === data.recommendedSeasonId) {
			div.classList.add("recommended");
		}

		div.innerHTML = `
			<strong>${season.seasonId}</strong>
			${season.seasonId === data.recommendedSeasonId ? "<span class='label'>(recommended)</span>" : ""}
			<div class="label">Time remaining: ${hoursLeft} hours</div>
			<div class="label">Star price: ${starPrice} coins</div>
			${isThisSeasonJoined
				? `<div class="label">You joined this season</div>
					<button class="buy-star-btn">Buy Star</button>`
				: isJoined
					? "<div class='label'>Locked to another season</div>"
					: "<button class='join-btn'>Join this season</button>"
			}
		`;

		const buyButton = div.querySelector(".buy-star-btn");
		if (buyButton) {
			buyButton.addEventListener("click", async () => {
				const res = await apiFetch("/buy-star", {
					method: "POST",
					body: JSON.stringify({ seasonId: season.seasonId })
				});
				const data = await res.json();
				if (!data.ok) {
					alert(data.error || "Purchase failed");
					return;
				}
				playerCoins = data.playerCoins;
				playerStars = data.playerStars;
				coinsDiv.innerText = `Coins: ${playerCoins}`;
				starsDiv.innerText = `Stars: ${playerStars}`;
				track("buy_star", { seasonId: season.seasonId, price: data.starPricePaid });
			});
		}

		const button = div.querySelector(".join-btn");
		if (button) {
			button.addEventListener("click", () => {
				localStorage.setItem("joinedSeasonId", season.seasonId);
				track("join_season", { seasonId: season.seasonId });
				location.reload();
			});
		}

		container.appendChild(div);
	});
}

document.getElementById("login-btn").addEventListener("click", async () => {
	const username = document.getElementById("username").value;
	const password = document.getElementById("password").value;
	const res = await apiFetch("/auth/login", {
		method: "POST",
		body: JSON.stringify({ username, password })
	});
	const data = await res.json();
	if (!data.ok) {
		alert(data.error || "Login failed");
		return;
	}
	await loadAuth();
	await refreshPlayer();
	track("login", {});
});

document.getElementById("signup-btn").addEventListener("click", async () => {
	const username = document.getElementById("username").value;
	const password = document.getElementById("password").value;
	const displayName = document.getElementById("display-name").value;
	const res = await apiFetch("/auth/signup", {
		method: "POST",
		body: JSON.stringify({ username, password, displayName })
	});
	const data = await res.json();
	if (!data.ok) {
		alert(data.error || "Signup failed");
		return;
	}
	await loadAuth();
	await refreshPlayer();
	track("signup", {});
});

logoutBtn.addEventListener("click", async () => {
	await apiFetch("/auth/logout", { method: "POST" });
	currentUser = null;
	await loadAuth();
});

profileSave.addEventListener("click", async () => {
	const displayName = profileDisplay.value;
	const res = await apiFetch("/profile", {
		method: "POST",
		body: JSON.stringify({ displayName })
	});
	const data = await res.json();
	if (!data.ok) {
		alert(data.error || "Update failed");
		return;
	}
	authStatus.innerText = `Logged in as ${data.displayName}`;
});

document.getElementById("feedback-send").addEventListener("click", async () => {
	const message = document.getElementById("feedback-text").value.trim();
	if (!message) return;
	await apiFetch("/feedback", {
		method: "POST",
		body: JSON.stringify({ message })
	});
	document.getElementById("feedback-text").value = "";
});

document.getElementById("dismiss-hint").addEventListener("click", () => {
	localStorage.setItem("dismissedHint", "true");
	onboarding.style.display = "none";
});

if (localStorage.getItem("dismissedHint") !== "true") {
	onboarding.style.display = "block";
}

loadAuth().then(async () => {
	await refreshPlayer();
	await loadSeasons();
});
	</script>
</body>
</html>
