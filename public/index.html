<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Too Many Coins</title>
	<style>
	:root {
		color-scheme: dark;
		--bg: #0b0f1d;
		--panel: #141a2e;
		--panel-strong: #1a2140;
		--border: #2a2f55;
		--text: #eaeaf0;
		--muted: #9aa3c4;
		--accent: #3b82f6;
		--success: #22c55e;
		--warning: #f59e0b;
		--danger: #ef4444;
	}
	body {
		font-family: "Inter", system-ui, sans-serif;
		background: radial-gradient(circle at top, #151c35 0%, #0b0f1d 45%, #060814 100%);
		color: var(--text);
		margin: 0;
		min-height: 100vh;
		display: flex;
		flex-direction: column;
	}
	header {
		position: sticky;
		top: 0;
		z-index: 15;
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1.5rem;
		padding: 1.25rem 2rem;
		background: rgba(8, 12, 26, 0.92);
		backdrop-filter: blur(12px);
		border-bottom: 1px solid var(--border);
	}
	main {
		padding: 2rem;
		max-width: 1200px;
		width: 100%;
		margin: 0 auto;
		box-sizing: border-box;
	}
	.app-title {
		display: flex;
		align-items: center;
		gap: 1rem;
	}
	.app-mark {
		width: 42px;
		height: 42px;
		border-radius: 14px;
		background: linear-gradient(135deg, #3b82f6, #6366f1);
		display: grid;
		place-items: center;
		font-weight: 700;
		color: white;
		box-shadow: 0 12px 24px rgba(59, 130, 246, 0.35);
	}
	.app-actions {
		display: flex;
		flex-direction: column;
		align-items: flex-end;
		gap: 0.65rem;
	}
	.nav-links a {
		color: #c5cae9;
		text-decoration: none;
		margin-left: 0.75rem;
		font-size: 0.85rem;
	}
	.live-status {
		display: inline-flex;
		align-items: center;
		gap: 0.4rem;
		font-size: 0.75rem;
		padding: 0.25rem 0.5rem;
		border-radius: 999px;
		border: 1px solid rgba(34, 197, 94, 0.5);
		color: #bbf7d0;
		background: rgba(34, 197, 94, 0.12);
	}
	.live-status::before {
		content: "";
		width: 6px;
		height: 6px;
		border-radius: 999px;
		background: #22c55e;
		box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
	}
	.live-status.offline {
		border-color: rgba(239, 68, 68, 0.5);
		color: #fecaca;
		background: rgba(239, 68, 68, 0.12);
	}
	.live-status.offline::before {
		background: #ef4444;
		box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
	}
	.live-status.reconnecting {
		border-color: rgba(245, 158, 11, 0.5);
		color: #fde68a;
		background: rgba(245, 158, 11, 0.12);
	}
	.live-status.reconnecting::before {
		background: #f59e0b;
		box-shadow: 0 0 8px rgba(245, 158, 11, 0.8);
	}
	.badge {
		font-size: 0.75rem;
		padding: 0.25rem 0.5rem;
		border-radius: 999px;
		background: #1f2544;
		border: 1px solid #2a2f55;
	}
	.badge.accent {
		background: rgba(59, 130, 246, 0.15);
		border-color: rgba(59, 130, 246, 0.5);
		color: #93c5fd;
	}
	.badge.bot {
		background: rgba(248, 113, 113, 0.15);
		border-color: rgba(248, 113, 113, 0.5);
		color: #fecaca;
	}
	.card {
		border: 1px solid var(--border);
		padding: 1.25rem;
		margin-bottom: 1rem;
		border-radius: 16px;
		background: var(--panel);
		box-shadow: 0 18px 30px rgba(0, 0, 0, 0.25);
	}
	.card-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1rem;
		margin-bottom: 1rem;
	}
	.hero-card {
		background: linear-gradient(140deg, rgba(59, 130, 246, 0.2), rgba(20, 26, 46, 0.95));
		border-color: rgba(59, 130, 246, 0.5);
	}
	.hero-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
		gap: 1.5rem;
	}
	.metric-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
		gap: 0.9rem;
	}
	.metric {
		padding: 0.75rem 0.9rem;
		background: rgba(10, 14, 28, 0.6);
		border-radius: 12px;
		border: 1px solid rgba(42, 47, 85, 0.8);
	}
	.stat-value {
		font-size: 1.1rem;
		font-weight: 600;
	}
	.dashboard-grid {
		display: grid;
		grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
		gap: 1.5rem;
		align-items: start;
	}
	.dashboard-main {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	.dashboard-side {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	.season-card {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	.season-card-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1rem;
	}
	.season-card-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
		gap: 0.75rem;
	}
	.season-actions {
		display: flex;
		gap: 0.5rem;
		flex-wrap: wrap;
	}
	.section-stack {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	.section-nav {
		display: flex;
		flex-wrap: wrap;
		gap: 0.75rem;
		font-size: 0.85rem;
	}
	.section-nav a {
		color: #c5cae9;
		text-decoration: none;
	}
	.split-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
		gap: 1rem;
	}
	.card-toggle {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 0.75rem;
	}
	.card-toggle .label {
		font-size: 0.9rem;
		color: #c5cae9;
	}
	.card-body {
		margin-top: 0.75rem;
	}
	.card.collapsed .card-body {
		display: none;
	}
	.recommended {
		border-color: #ffd166;
		background: rgba(255, 209, 102, 0.08);
	}
	.label {
		font-size: 0.8rem;
		color: #aaa;
	}
	input, textarea, button {
		background: #0f1220;
		border: 1px solid #2a2f55;
		color: #eaeaf0;
		padding: 0.5rem 0.75rem;
		border-radius: 8px;
	}
	button {
		cursor: pointer;
	}
	button.primary {
		background: #3b82f6;
		border-color: #3b82f6;
	}
	.row {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		flex-wrap: wrap;
	}
	.stack {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}
	.toast {
		padding: 0.6rem 0.8rem;
		border-radius: 8px;
		background: #11162b;
		border: 1px solid #2a2f55;
		font-size: 0.85rem;
	}
	.toast.error {
		border-color: #ef4444;
		color: #fecaca;
	}
	.toast.success {
		border-color: #22c55e;
		color: #bbf7d0;
	}
	.muted {
		color: #9aa3c4;
		font-size: 0.8rem;
	}
	.grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
		gap: 1rem;
	}
	.notice {
		padding: 0.75rem 1rem;
		border-radius: 10px;
		border: 1px solid #2a2f55;
		background: #11162b;
		margin-bottom: 0.5rem;
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1rem;
	}
	.notice.info { border-color: #2a2f55; }
	.notice.warn { border-color: #f59e0b; color: #fde68a; }
	.notice.urgent { border-color: #ef4444; color: #fecaca; }
	.notice button { padding: 0.25rem 0.6rem; }
	.notice.read {
		opacity: 0.55;
		filter: saturate(0.7);
	}
	.notice.unread {
		box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.45), 0 0 18px rgba(59, 130, 246, 0.15);
	}
	.notice.clickable { cursor: pointer; }
	.notification-panel {
		position: fixed;
		right: 1.5rem;
		bottom: 1.5rem;
		width: min(420px, 92vw);
		max-height: 70vh;
		overflow: auto;
		padding: 1rem;
		border-radius: 12px;
		background: #141a2e;
		border: 1px solid #2a2f55;
		box-shadow: 0 20px 40px rgba(0,0,0,0.35);
		z-index: 20;
	}
	.notification-section {
		margin-top: 0.75rem;
	}
	.view { display: none; }
	.view.active { display: block; }
	.footer { margin-top: auto; text-align: center; font-size: 0.8rem; color: #9aa3c4; padding: 1.5rem 0; }
	@media (max-width: 720px) {
		main {
			padding: 1.25rem;
		}
		header {
			flex-direction: column;
			align-items: flex-start;
			gap: 0.75rem;
			padding: 1rem 1.25rem;
		}
		.app-actions {
			align-items: flex-start;
		}
		.nav-links a {
			margin-left: 0;
			margin-right: 0.75rem;
		}
		.dashboard-grid {
			grid-template-columns: 1fr;
		}
		.grid {
			grid-template-columns: 1fr;
		}
		.row {
			flex-direction: column;
			align-items: stretch;
		}
		.row input,
		.row textarea,
		.row select,
		.row button,
		.stack input,
		.stack textarea,
		.stack select,
		.stack button {
			width: 100%;
		}
		.notification-panel {
			right: 0.75rem;
			bottom: 0.75rem;
			width: min(420px, 94vw);
			max-height: 75vh;
		}
		.notice {
			flex-direction: column;
			align-items: flex-start;
		}
		.footer {
			position: static;
		}
	}
	</style>
</head>
<body>
	<header>
		<div class="app-title">
			<div class="app-mark">TC</div>
			<div>
				<h1>Too Many Coins</h1>
				<div class="label">Season command center · server-authoritative economy</div>
			</div>
		</div>
		<div class="app-actions">
			<div class="row">
				<span class="badge">ALPHA 1</span>
				<span id="stat-pill" class="badge accent" style="display:none;"></span>
				<span id="live-status" class="live-status">Live updates</span>
			</div>
			<nav class="nav-links">
				<a href="#/home">Home</a>
				<a href="#/about">About</a>
				<a href="#/playtest">Playtest</a>
				<a href="#/leaderboard">Leaderboard</a>
				<a id="signup-link" href="#/signup">Sign up</a>
				<a id="moderator-link" href="#/moderator" style="display:none;">Moderate</a>
				<a id="admin-link" href="#/admin" style="display:none;">Admin</a>
			</nav>
		</div>
	</header>

	<div id="notification-panel" class="notification-panel" style="display:none;">
		<div class="row" style="justify-content:space-between; align-items:center;">
			<div>
				<strong>Notifications</strong>
				<span id="notification-count" class="badge accent" style="display:none; margin-left:0.5rem;"></span>
			</div>
			<button id="notification-hide">Hide</button>
		</div>
		<div class="notification-section">
			<div class="label">Unread</div>
			<div id="notification-unread" class="stack"></div>
		</div>
		<div class="notification-section">
			<div class="label">Read</div>
			<div id="notification-read" class="stack"></div>
		</div>
	</div>

	<main id="app">
		<section id="view-home" class="view active">
			<div class="card hero-card">
				<div class="hero-grid">
					<div>
						<div class="label">Season dashboard</div>
						<h2 style="margin:0.35rem 0 0;">Real-time economy & star pricing</h2>
						<div class="muted">Live season time, emission, and price updates from the server.</div>
					</div>
					<div class="metric-grid">
						<div class="metric">
							<div class="label">Current season</div>
							<div id="hero-season-id" class="stat-value">Season 1</div>
						</div>
						<div class="metric">
							<div class="label">Time remaining</div>
							<div id="hero-season-remaining" class="stat-value">--</div>
						</div>
						<div class="metric">
							<div class="label">Star price</div>
							<div id="hero-star-price" class="stat-value">--</div>
						</div>
					</div>
				</div>
			</div>

			<div class="dashboard-grid">
				<div class="dashboard-main">
					<div id="locked-message" class="label"></div>
					<div class="card" id="season-snapshot" style="display:none;">
						<div class="card-header">
							<div>
								<div class="label">Season snapshot</div>
								<div id="season-title" class="stat-value">Season 1</div>
							</div>
							<span id="season-status" class="badge accent">Active</span>
						</div>
						<div class="metric-grid">
							<div class="metric">
								<div class="label">Time remaining</div>
								<div id="season-remaining" class="stat-value">--</div>
							</div>
							<div class="metric">
								<div class="label">Star price</div>
								<div id="season-star-price" class="stat-value">--</div>
							</div>
							<div class="metric">
								<div class="label">Coins in circulation</div>
								<div id="season-coins" class="stat-value">--</div>
							</div>
							<div class="metric">
								<div class="label">Emission / min</div>
								<div id="season-emission" class="stat-value">--</div>
							</div>
						</div>
					</div>
					<div id="seasons" class="grid">Loading season…</div>
				</div>

				<div class="dashboard-side">
					<div class="card" id="auth-card">
						<div id="auth-status" class="label">Checking session…</div>
						<div id="auth-forms" class="stack">
							<div class="row">
								<input id="username" placeholder="Username" />
								<input id="password" type="password" placeholder="Password" />
							</div>
							<div class="row">
								<button class="primary" id="login-btn" type="button">Log in</button>
								<a class="muted" href="#/signup">Create account</a>
							</div>
							<div class="row">
								<a class="muted" href="#/reset">Forgot password?</a>
							</div>
							<div class="muted">Alpha accounts are local to this test.</div>
						</div>
						<button id="logout-btn" style="display:none;">Log out</button>
					</div>

					<div id="toast" class="toast" style="display:none;"></div>

					<div class="grid" id="player-panels" style="display:none;">
						<div class="card" id="profile-card">
							<div class="card-toggle">
								<div class="label">User panel</div>
							</div>
							<div class="card-body">
								<div class="row">
									<img id="profile-avatar-img" alt="Avatar" style="width:64px; height:64px; border-radius:12px; object-fit:cover; border:1px solid #2a2f55;" />
									<div>
										<div id="profile-name"></div>
										<div id="profile-role" class="label"></div>
										<div id="profile-coins" class="label"></div>
										<div id="profile-stars" class="label"></div>
									</div>
								</div>
								<input id="profile-display" placeholder="Display name" />
								<input id="profile-pronouns" placeholder="Pronouns" />
								<input id="profile-location" placeholder="Location" />
								<input id="profile-website" placeholder="Website" />
								<input id="profile-avatar" placeholder="Avatar URL" />
								<textarea id="profile-bio" rows="3" placeholder="Bio"></textarea>
								<input id="profile-email" placeholder="Email (for password reset)" />
								<button id="profile-save">Save</button>
							</div>
						</div>
					</div>

					<div class="card" id="onboarding" style="display:none;">
						<div class="label">Quick start</div>
						<div>Play the current season. Earn coins over time. Spend them on stars.</div>
						<button id="dismiss-hint">Got it</button>
					</div>

					<div class="card" id="actions-card" style="display:none;">
						<div class="label">Quick actions</div>
						<div class="row">
							<button id="claim-daily" class="primary">Daily claim</button>
							<button id="claim-activity">Activity claim</button>
						</div>
						<div id="actions-status" class="muted"></div>
					</div>

					<div class="card" id="whitelist-request-card" style="display:none;">
						<div class="label">IP whitelist request</div>
						<div class="row">
							<input id="whitelist-reason" placeholder="Reason (optional)" />
							<button id="whitelist-request-btn" class="primary">Request approval</button>
						</div>
						<div id="whitelist-request-status" class="muted"></div>
					</div>
				</div>
			</div>
		</section>

		<section id="view-about" class="view">
			<div class="section-stack">
				<div class="card hero-card">
					<div class="card-header">
						<div>
							<div class="label">About Too Many Coins</div>
							<h2 style="margin:0.35rem 0 0;">A server-authoritative economy built on scarcity.</h2>
							<div class="muted">Coins inflate, stars stay scarce, and every purchase is priced on the server.</div>
						</div>
						<div class="section-nav">
							<a href="#/home">Back to home</a>
							<a href="#/playtest">Playtest notes</a>
						</div>
					</div>
				</div>

				<div class="split-grid">
					<div class="card">
						<div class="label">Core loop</div>
						<ul class="muted" style="margin:0.5rem 0 0; padding-left:1.2rem;">
							<li>Earn coins through limited faucets.</li>
							<li>Buy stars as the season score.</li>
							<li>Prices rise as time passes and demand grows.</li>
						</ul>
					</div>
					<div class="card">
						<div class="label">Design ideals</div>
						<ul class="muted" style="margin:0.5rem 0 0; padding-left:1.2rem;">
							<li>Simple, transparent, and fair.</li>
							<li>Server authority for all economy logic.</li>
							<li>Late-season scarcity stays meaningful.</li>
						</ul>
					</div>
				</div>
			</div>
		</section>

		<section id="view-playtest" class="view">
			<div class="section-stack">
				<div class="card hero-card">
					<div class="card-header">
						<div>
							<div class="label">Playtest focus</div>
							<h2 style="margin:0.35rem 0 0;">Verify pacing, clarity, and late-season pressure.</h2>
							<div class="muted">Short sessions are fine—every data point helps tune the economy.</div>
						</div>
						<div class="section-nav">
							<a href="#/home">Back to home</a>
							<a href="#/about">About</a>
						</div>
					</div>
				</div>
				<div class="split-grid">
					<div class="card">
						<div class="label">What to test</div>
						<ul class="muted" style="margin:0.5rem 0 0; padding-left:1.2rem;">
							<li>Clarity of the core loop.</li>
							<li>Faucet pacing vs. star price growth.</li>
							<li>Perceived late-season scarcity.</li>
						</ul>
					</div>
					<div class="card">
						<div class="label">Suggested cadence</div>
						<div class="muted" style="margin-top:0.5rem;">Play 10–20 minutes per day and leave feedback in-app.</div>
					</div>
				</div>
			</div>
		</section>

		<section id="view-leaderboard" class="view">
			<div class="section-stack">
				<div class="card hero-card">
					<div class="card-header">
						<div>
							<div class="label">Leaderboard</div>
							<h2 style="margin:0.35rem 0 0;">Season rankings with bots labeled.</h2>
							<div class="muted">Server-authoritative ordering with stable tiebreakers.</div>
						</div>
						<div class="section-nav">
							<a href="#/home">Back to home</a>
						</div>
					</div>
				</div>

				<div class="card">
					<div class="row" style="margin-top:0.5rem;">
						<input id="leaderboard-search" placeholder="Search username or display name" />
						<select id="leaderboard-sort">
							<option value="stars_desc">Stars (high → low)</option>
							<option value="stars_asc">Stars (low → high)</option>
							<option value="coins_spent_desc">Coins spent (high → low)</option>
							<option value="coins_spent_asc">Coins spent (low → high)</option>
							<option value="last_star_time_asc">Last star time (earlier first)</option>
							<option value="created_at_asc">Created at (oldest first)</option>
						</select>
						<select id="leaderboard-page-size">
							<option value="25">25 / page</option>
							<option value="50" selected>50 / page</option>
							<option value="100">100 / page</option>
						</select>
					</div>
					<div class="row" style="margin-top:0.5rem;">
						<label class="label"><input type="checkbox" id="leaderboard-include-bots" checked /> Include bots</label>
						<label class="label"><input type="checkbox" id="leaderboard-bot-only" /> Bot-only</label>
						<button id="leaderboard-apply" class="primary">Apply</button>
					</div>
				</div>

				<div id="leaderboard-results" class="stack"></div>
				<div class="row" style="justify-content:space-between; margin-top:0.5rem;">
					<button id="leaderboard-prev">Previous</button>
					<span id="leaderboard-page" class="label"></span>
					<button id="leaderboard-next">Next</button>
				</div>
			</div>
		</section>

		<section id="view-signup" class="view">
			<div class="section-stack" style="max-width: 560px;">
				<div class="card hero-card">
					<div class="label">Create account</div>
					<h2 style="margin:0.35rem 0 0;">Join the season in minutes.</h2>
					<div class="muted">All economy logic is enforced server-side.</div>
				</div>
				<div class="card">
					<div class="stack">
						<input id="signup-username" placeholder="Username" />
						<input id="signup-display-name" placeholder="Display name" />
						<input id="signup-email" placeholder="Email" />
						<input id="signup-password" type="password" placeholder="Password" />
						<button class="primary" id="signup-btn">Sign up</button>
						<div class="label"><a href="#/home">Back to login</a></div>
						<div id="signup-toast" class="toast" style="display:none;"></div>
					</div>
				</div>
			</div>
		</section>

		<section id="view-reset" class="view">
			<div class="section-stack" style="max-width: 560px;">
				<div class="card hero-card">
					<div class="label">Account recovery</div>
					<h2 style="margin:0.35rem 0 0;">Reset access securely.</h2>
					<div class="muted">Reset tokens are validated on the server.</div>
				</div>
				<div class="card">
					<div class="stack">
						<div class="label">Request reset link</div>
						<input id="reset-identifier" placeholder="Email or username" />
						<button class="primary" id="reset-request-btn">Send reset email</button>
						<div id="reset-request-status" class="label"></div>
						<hr style="border:0; border-top:1px solid #2a2f55; width:100%;" />
						<div class="label">Have a token?</div>
						<input id="reset-token" placeholder="Reset token" />
						<input id="reset-new-password" type="password" placeholder="New password" />
						<button class="primary" id="reset-confirm-btn">Reset password</button>
						<div id="reset-confirm-status" class="label"></div>
						<div class="label"><a href="#/home">Back to login</a></div>
					</div>
				</div>
			</div>
		</section>

		<section id="view-admin" class="view">
			<div class="section-stack">
				<div class="card hero-card">
					<div class="card-header">
						<div>
							<div class="label">Admin console</div>
							<h2 style="margin:0.35rem 0 0;">Monitor the economy and keep the system fair.</h2>
							<div class="muted">All adjustments are applied server-side.</div>
						</div>
						<div class="section-nav">
							<a href="#/home">Back to game</a>
							<a href="#/admin-telemetry">Telemetry</a>
							<a href="#/admin-economy">Economy</a>
							<a href="#/admin-star-log">Star log</a>
							<a href="#/admin-bots">Bots</a>
						</div>
					</div>
				</div>

				<div class="card" id="admin-setup" style="display:none;">
					<div class="card-toggle">
						<div class="label">Admin setup</div>
					</div>
					<div class="card-body">
						<input id="admin-setup-key" placeholder="Setup key" />
						<button id="save-key" class="primary">Save</button>
						<div id="key-status" class="label"></div>
					</div>
				</div>

			<div class="card" id="admin-content" data-collapsible="true" style="display:none;">
				<div class="card-toggle">
					<div class="label">Season summary</div>
					<button class="toggle-btn" type="button">Hide</button>
				</div>
				<div class="card-body">
					<div id="season-summary">Loading…</div>
					<div class="row" style="margin-top:0.5rem;">
						<button id="refresh" class="primary">Refresh</button>
					</div>
				</div>
			</div>

			<div class="card" id="role-management" data-collapsible="true" style="display:none;">
				<div class="card-toggle">
					<div class="label">Role management</div>
					<button class="toggle-btn" type="button">Hide</button>
				</div>
				<div class="card-body">
					<div class="row" style="margin-top:0.5rem;">
						<input id="role-username" placeholder="Username" />
						<select id="role-value">
							<option value="moderator">Moderator</option>
							<option value="admin">Admin</option>
						</select>
						<button id="role-save" class="primary">Set role</button>
					</div>
					<div id="role-status" class="label"></div>
				</div>
			</div>

			<div class="card" id="ip-whitelist" data-collapsible="true" style="display:none;">
				<div class="card-toggle">
					<div class="label">IP whitelist (max accounts)</div>
					<button class="toggle-btn" type="button">Hide</button>
				</div>
				<div class="card-body">
					<div class="row" style="margin-top:0.5rem;">
						<input id="ip-whitelist-value" placeholder="IP address" />
						<button id="ip-whitelist-save" class="primary">Allow</button>
						<button id="ip-whitelist-remove">Remove</button>
					</div>
					<div id="ip-whitelist-status" class="label"></div>
				</div>
			</div>

			<div class="card" id="whitelist-requests" data-collapsible="true" style="display:none;">
				<div class="card-toggle">
					<div class="label">Pending whitelist requests</div>
					<button class="toggle-btn" type="button">Hide</button>
				</div>
				<div class="card-body">
					<div id="whitelist-requests-list" class="label">Loading…</div>
				</div>
			</div>

			<div class="card" id="admin-notify" data-collapsible="true" style="display:none;">
				<div class="card-toggle">
					<div class="label">Send notification</div>
					<button class="toggle-btn" type="button">Hide</button>
				</div>
				<div class="card-body">
					<div class="row" style="margin-top:0.5rem;">
						<select id="notify-target">
							<option value="all">All</option>
							<option value="user">Players</option>
							<option value="moderator">Moderators</option>
							<option value="admin">Admins</option>
						</select>
						<input id="notify-account" placeholder="Account ID (optional)" />
						<select id="notify-level">
							<option value="info">Info</option>
							<option value="warn">Warn</option>
							<option value="urgent">Urgent</option>
						</select>
					</div>
					<div class="row" style="margin-top:0.5rem;">
						<input id="notify-expires" placeholder="Expires (RFC3339, optional)" />
						<input id="notify-link" placeholder="Link (e.g. #/admin)" />
						<input id="notify-message" placeholder="Message" style="flex:1;" />
						<button id="notify-send" class="primary">Send</button>
					</div>
					<div id="notify-status" class="label"></div>
				</div>
			</div>

			<div class="card" id="admin-settings" data-collapsible="true" style="display:none;">
				<div class="card-toggle">
					<div class="label">Global settings</div>
					<button class="toggle-btn" type="button">Hide</button>
				</div>
				<div class="card-body">
					<div class="row" style="margin-top:0.5rem;">
						<div class="stack" style="min-width:160px;">
							<label class="label">Active drip interval (s)</label>
							<input id="gs-active-interval" type="range" min="15" max="300" step="15" value="60" />
							<span id="gs-active-interval-value" class="label"></span>
						</div>
						<div class="stack" style="min-width:160px;">
							<label class="label">Idle drip interval (s)</label>
							<input id="gs-idle-interval" type="range" min="60" max="900" step="30" value="240" />
							<span id="gs-idle-interval-value" class="label"></span>
						</div>
						<div class="stack" style="min-width:160px;">
							<label class="label">Active drip amount</label>
							<input id="gs-active-amount" type="range" min="1" max="10" step="1" value="2" />
							<span id="gs-active-amount-value" class="label"></span>
						</div>
						<div class="stack" style="min-width:160px;">
							<label class="label">Idle drip amount</label>
							<input id="gs-idle-amount" type="range" min="1" max="5" step="1" value="1" />
							<span id="gs-idle-amount-value" class="label"></span>
						</div>
					</div>
					<div class="row" style="margin-top:0.5rem;">
						<div class="stack" style="min-width:180px;">
							<label class="label">Activity window (s)</label>
							<input id="gs-activity-window" type="range" min="30" max="600" step="30" value="120" />
							<span id="gs-activity-window-value" class="label"></span>
						</div>
						<select id="gs-drip-enabled">
							<option value="">Drip enabled?</option>
							<option value="true">Enabled</option>
							<option value="false">Disabled</option>
						</select>
						<button id="gs-load" class="primary">Load</button>
						<button id="gs-save" class="primary">Save</button>
					</div>
					<div id="gs-status" class="label"></div>
				</div>
			</div>

			<div class="card" id="admin-player-controls" data-collapsible="true" style="display:none;">
				<div class="card-toggle">
					<div class="label">Player controls</div>
					<button class="toggle-btn" type="button">Hide</button>
				</div>
				<div class="card-body">
					<div class="row" style="margin-top:0.5rem;">
						<input id="pc-username" placeholder="Username" />
						<input id="pc-player-id" placeholder="Player ID" />
						<button id="pc-load" class="primary">Load</button>
					</div>
					<div class="row" style="margin-top:0.5rem;">
						<div class="stack" style="min-width:160px;">
							<label class="label"><input type="checkbox" id="pc-set-coins-enabled" /> Set coins</label>
							<input id="pc-set-coins" type="range" min="0" max="10000" step="50" value="0" disabled />
							<span id="pc-set-coins-value" class="label"></span>
						</div>
						<div class="stack" style="min-width:160px;">
							<label class="label"><input type="checkbox" id="pc-add-coins-enabled" /> Add coins</label>
							<input id="pc-add-coins" type="range" min="0" max="2000" step="25" value="0" disabled />
							<span id="pc-add-coins-value" class="label"></span>
						</div>
						<div class="stack" style="min-width:160px;">
							<label class="label"><input type="checkbox" id="pc-set-stars-enabled" /> Set stars</label>
							<input id="pc-set-stars" type="range" min="0" max="500" step="1" value="0" disabled />
							<span id="pc-set-stars-value" class="label"></span>
						</div>
						<div class="stack" style="min-width:160px;">
							<label class="label"><input type="checkbox" id="pc-add-stars-enabled" /> Add stars</label>
							<input id="pc-add-stars" type="range" min="0" max="100" step="1" value="0" disabled />
							<span id="pc-add-stars-value" class="label"></span>
						</div>
					</div>
					<div class="row" style="margin-top:0.5rem;">
						<div class="stack" style="min-width:200px;">
							<label class="label"><input type="checkbox" id="pc-drip-mult-enabled" /> Drip multiplier</label>
							<input id="pc-drip-mult" type="range" min="0.1" max="3" step="0.1" value="1" disabled />
							<span id="pc-drip-mult-value" class="label"></span>
						</div>
						<select id="pc-drip-paused">
							<option value="">Pause?</option>
							<option value="true">Pause drip</option>
							<option value="false">Resume drip</option>
						</select>
						<button id="pc-touch" class="primary">Touch active</button>
						<button id="pc-save" class="primary">Apply</button>
					</div>
					<div class="row" style="margin-top:0.5rem;">
						<label class="label"><input type="checkbox" id="pc-is-bot-enabled" /> Set bot status</label>
						<select id="pc-is-bot" disabled>
							<option value="">Bot status</option>
							<option value="true">Bot</option>
							<option value="false">Human</option>
						</select>
						<label class="label"><input type="checkbox" id="pc-bot-profile-enabled" /> Set bot profile</label>
						<select id="pc-bot-profile" disabled>
							<option value="">None</option>
							<option value="threshold_buyer">Threshold buyer</option>
							<option value="cautious_buyer">Cautious buyer</option>
							<option value="late_fomo">Late FOMO</option>
						</select>
					</div>
					<div id="pc-status" class="label"></div>
				</div>
			</div>

				<div class="card" id="no-access" style="display:none;">
					<div class="label">Not authorized</div>
					<div class="label">You need an admin account to view this page.</div>
				</div>
			</div>
		</section>

		<section id="view-admin-economy" class="view">
			<div class="section-stack">
				<div class="card hero-card">
					<div class="card-header">
						<div>
							<div class="label">Economy controls</div>
							<h2 style="margin:0.35rem 0 0;">Tune daily emission and feature gates.</h2>
							<div class="muted">Changes apply instantly on the server.</div>
						</div>
						<div class="section-nav">
							<a href="#/admin">Admin home</a>
							<a href="#/admin-telemetry">Telemetry</a>
							<a href="#/admin-star-log">Star log</a>
						</div>
					</div>
				</div>

				<div class="card" id="econ-no-access" style="display:none;">
					<div class="label">Not authorized</div>
				</div>

				<div class="card" data-collapsible="true">
					<div class="card-toggle">
						<div class="label">Daily emission target</div>
						<button class="toggle-btn" type="button">Hide</button>
					</div>
					<div class="card-body">
						<div class="row">
							<input id="emission" type="range" min="0" max="5000" step="50" />
							<span id="emission-value"></span>
						</div>
						<div class="row" style="margin-top:0.5rem;">
							<label><input type="checkbox" id="faucets" /> Faucets enabled</label>
							<label><input type="checkbox" id="sinks" /> Sinks enabled</label>
							<label><input type="checkbox" id="telemetry" /> Telemetry enabled</label>
						</div>
						<div class="row" style="margin-top:0.5rem;">
							<button id="econ-save" class="primary">Save</button>
						</div>
						<div id="econ-status" class="label"></div>
					</div>
				</div>
			</div>
		</section>

		<section id="view-admin-telemetry" class="view">
			<div class="section-stack">
				<div class="card hero-card">
					<div class="card-header">
						<div>
							<div class="label">Telemetry</div>
							<h2 style="margin:0.35rem 0 0;">Observe live activity and usage patterns.</h2>
							<div class="muted">Aggregates are server-tracked for fairness.</div>
						</div>
						<div class="section-nav">
							<a href="#/admin">Admin home</a>
							<a href="#/admin-economy">Economy</a>
							<a href="#/admin-star-log">Star log</a>
						</div>
					</div>
				</div>

				<div class="card" id="tele-no-access" style="display:none;">
					<div class="label">Not authorized</div>
				</div>

				<div class="card" data-collapsible="true">
					<div class="card-toggle">
						<div class="label">Events by hour (last 48h)</div>
						<button class="toggle-btn" type="button">Hide</button>
					</div>
					<div class="card-body">
						<table>
							<thead>
								<tr><th>Hour</th><th>Event</th><th>Count</th></tr>
							</thead>
							<tbody id="telemetry-body"></tbody>
						</table>
					</div>
				</div>
			</div>

		</section>

		<section id="view-admin-star-log" class="view">
			<div class="section-stack">
				<div class="card hero-card">
					<div class="card-header">
						<div>
							<div class="label">Star purchases</div>
							<h2 style="margin:0.35rem 0 0;">Audit pricing and transaction flow.</h2>
							<div class="muted">All entries are server-validated.</div>
						</div>
						<div class="section-nav">
							<a href="#/admin">Admin home</a>
							<a href="#/admin-telemetry">Telemetry</a>
							<a href="#/admin-economy">Economy</a>
						</div>
					</div>
				</div>

				<div class="card" data-collapsible="true">
					<div class="card-toggle">
						<div class="label">Star purchase log</div>
						<button class="toggle-btn" type="button">Hide</button>
					</div>
					<div class="card-body">
						<div class="row" style="margin-top:0.5rem;">
							<select id="star-log-filter-key">
								<option value="">Filter by...</option>
								<option value="accountId">Account ID</option>
								<option value="playerId">Player ID</option>
								<option value="seasonId">Season ID</option>
								<option value="purchaseType">Purchase type</option>
								<option value="variant">Variant</option>
								<option value="from">From (RFC3339)</option>
								<option value="to">To (RFC3339)</option>
								<option value="minPrice">Min price</option>
								<option value="maxPrice">Max price</option>
								<option value="minCoinsBefore">Min coins before</option>
								<option value="maxCoinsBefore">Max coins before</option>
								<option value="minCoinsAfter">Min coins after</option>
								<option value="maxCoinsAfter">Max coins after</option>
								<option value="minStarsBefore">Min stars before</option>
								<option value="maxStarsBefore">Max stars before</option>
								<option value="minStarsAfter">Min stars after</option>
								<option value="maxStarsAfter">Max stars after</option>
								<option value="limit">Limit</option>
							</select>
							<input id="star-log-filter-value" placeholder="Value" />
							<button id="star-log-load" class="primary">Apply</button>
							<button id="star-log-clear">Clear</button>
						</div>
						<div class="row" style="margin-top:0.5rem;">
							<button id="star-log-export-csv">Export CSV</button>
							<button id="star-log-export-json">Export JSON</button>
						</div>
						<div id="star-log-status" class="label"></div>
					</div>
				</div>

				<div class="card" data-collapsible="true">
					<div class="card-toggle">
						<div class="label">Live purchase feed</div>
						<button class="toggle-btn" type="button">Hide</button>
					</div>
					<div class="card-body">
						<div id="star-log-list" class="stack"></div>
					</div>
				</div>

				<div class="card" id="star-log-no-access" style="display:none;">
					<div class="label">Not authorized</div>
					<div class="label">You need an admin account to view this page.</div>
				</div>
			</div>
		</section>

		<section id="view-admin-bots" class="view">
			<div class="section-stack">
				<div class="card hero-card">
					<div class="card-header">
						<div>
							<div class="label">Bot control</div>
							<h2 style="margin:0.35rem 0 0;">Manage bots globally and individually.</h2>
							<div class="muted">Bot actions remain server-authoritative.</div>
						</div>
						<div class="section-nav">
							<a href="#/admin">Admin home</a>
							<a href="#/admin-telemetry">Telemetry</a>
							<a href="#/admin-economy">Economy</a>
							<a href="#/admin-star-log">Star log</a>
						</div>
					</div>
				</div>

				<div class="card" id="bots-no-access" style="display:none;">
					<div class="label">Not authorized</div>
				</div>

				<div class="card" data-collapsible="true" id="bots-global" style="display:none;">
					<div class="card-toggle">
						<div class="label">Global bot controls</div>
						<button class="toggle-btn" type="button">Hide</button>
					</div>
					<div class="card-body">
						<div class="row" style="margin-top:0.5rem;">
							<label class="label"><input type="checkbox" id="bots-enabled-toggle" /> Bots enabled</label>
							<div class="stack" style="min-width:200px;">
								<label class="label">Min seconds between bot star buys</label>
								<input id="bot-min-interval" type="range" min="30" max="600" step="30" value="90" />
								<span id="bot-min-interval-value" class="label"></span>
							</div>
							<button id="bots-global-save" class="primary">Save</button>
						</div>
						<div id="bots-global-status" class="label"></div>
					</div>
				</div>

				<div class="card" data-collapsible="true" id="bots-individual" style="display:none;">
					<div class="card-toggle">
						<div class="label">Individual bot control</div>
						<button class="toggle-btn" type="button">Hide</button>
					</div>
					<div class="card-body">
						<div class="row" style="margin-top:0.5rem;">
							<select id="bot-select">
								<option value="">Select bot</option>
							</select>
							<button id="bot-load" class="primary">Load</button>
						</div>
						<div class="row" style="margin-top:0.5rem;">
							<label class="label"><input type="checkbox" id="bot-is-bot-enabled" /> Set bot status</label>
							<select id="bot-is-bot" disabled>
								<option value="">Bot status</option>
								<option value="true">Bot</option>
								<option value="false">Human</option>
							</select>
							<label class="label"><input type="checkbox" id="bot-profile-enabled" /> Set bot profile</label>
							<select id="bot-profile" disabled>
								<option value="">None</option>
								<option value="threshold_buyer">Threshold buyer</option>
								<option value="cautious_buyer">Cautious buyer</option>
								<option value="late_fomo">Late FOMO</option>
							</select>
						</div>
						<div class="row" style="margin-top:0.5rem;">
							<div class="stack" style="min-width:160px;">
								<label class="label"><input type="checkbox" id="bot-set-coins-enabled" /> Set coins</label>
								<input id="bot-set-coins" type="range" min="0" max="10000" step="50" value="0" disabled />
								<span id="bot-set-coins-value" class="label"></span>
							</div>
							<div class="stack" style="min-width:160px;">
								<label class="label"><input type="checkbox" id="bot-add-coins-enabled" /> Add coins</label>
								<input id="bot-add-coins" type="range" min="0" max="2000" step="25" value="0" disabled />
								<span id="bot-add-coins-value" class="label"></span>
							</div>
							<div class="stack" style="min-width:160px;">
								<label class="label"><input type="checkbox" id="bot-set-stars-enabled" /> Set stars</label>
								<input id="bot-set-stars" type="range" min="0" max="500" step="1" value="0" disabled />
								<span id="bot-set-stars-value" class="label"></span>
							</div>
							<div class="stack" style="min-width:160px;">
								<label class="label"><input type="checkbox" id="bot-add-stars-enabled" /> Add stars</label>
								<input id="bot-add-stars" type="range" min="0" max="100" step="1" value="0" disabled />
								<span id="bot-add-stars-value" class="label"></span>
							</div>
						</div>
						<div class="row" style="margin-top:0.5rem;">
							<div class="stack" style="min-width:200px;">
								<label class="label"><input type="checkbox" id="bot-drip-mult-enabled" /> Drip multiplier</label>
								<input id="bot-drip-mult" type="range" min="0.1" max="3" step="0.1" value="1" disabled />
								<span id="bot-drip-mult-value" class="label"></span>
							</div>
							<select id="bot-drip-paused">
								<option value="">Pause?</option>
								<option value="true">Pause drip</option>
								<option value="false">Resume drip</option>
							</select>
							<button id="bot-touch" class="primary">Touch active</button>
							<button id="bot-save" class="primary">Apply</button>
						</div>
						<div id="bot-status" class="label"></div>
					</div>
				</div>
			</div>
		</section>

		<section id="view-moderator" class="view">
			<div class="section-stack">
				<div class="card hero-card">
					<div class="card-header">
						<div>
							<div class="label">Moderator tools</div>
							<h2 style="margin:0.35rem 0 0;">Keep profiles clean and accurate.</h2>
							<div class="muted">Edits are validated and stored server-side.</div>
						</div>
						<div class="section-nav">
							<a href="#/home">Back to game</a>
						</div>
					</div>
				</div>

				<div class="card" id="moderator-content" data-collapsible="true" style="display:none;">
					<div class="card-toggle">
						<div class="label">Edit profile</div>
						<button class="toggle-btn" type="button">Hide</button>
					</div>
					<div class="card-body">
						<div class="row" style="margin-top:0.5rem;">
							<input id="mod-username-view" placeholder="Username" />
							<button id="mod-load-view" class="primary">Load</button>
						</div>
						<div class="row" style="margin-top:0.5rem;">
							<input id="mod-display-name-view" placeholder="Display name" />
							<button id="mod-save-view" class="primary">Update</button>
						</div>
						<div class="row" style="margin-top:0.5rem;">
							<input id="mod-email-view" placeholder="Email" />
							<input id="mod-pronouns-view" placeholder="Pronouns" />
							<input id="mod-location-view" placeholder="Location" />
						</div>
						<div class="row" style="margin-top:0.5rem;">
							<input id="mod-website-view" placeholder="Website" />
							<input id="mod-avatar-view" placeholder="Avatar URL" />
						</div>
						<textarea id="mod-bio-view" rows="3" placeholder="Bio"></textarea>
						<div id="mod-status-view" class="label"></div>
					</div>
				</div>

				<div class="card" id="mod-no-access" style="display:none;">
					<div class="label">Not authorized</div>
					<div class="label">You need a moderator or admin account to view this page.</div>
				</div>
			</div>
		</section>
	</main>

	<div class="footer">Made by AI</div>

	<script>
const authStatus = document.getElementById("auth-status");
const authForms = document.getElementById("auth-forms");
const logoutBtn = document.getElementById("logout-btn");
const profileName = document.getElementById("profile-name");
const profileRole = document.getElementById("profile-role");
const profileDisplay = document.getElementById("profile-display");
const profileEmail = document.getElementById("profile-email");
const profilePronouns = document.getElementById("profile-pronouns");
const profileLocation = document.getElementById("profile-location");
const profileWebsite = document.getElementById("profile-website");
const profileAvatar = document.getElementById("profile-avatar");
const profileAvatarImg = document.getElementById("profile-avatar-img");
const profileBio = document.getElementById("profile-bio");
const seasonSnapshot = document.getElementById("season-snapshot");
const profileSave = document.getElementById("profile-save");
const playerPanels = document.getElementById("player-panels");
const coinsDiv = document.getElementById("profile-coins");
const starsDiv = document.getElementById("profile-stars");
const onboarding = document.getElementById("onboarding");
const actionsCard = document.getElementById("actions-card");
const whitelistRequestCard = document.getElementById("whitelist-request-card");
const actionsStatus = document.getElementById("actions-status");
const toast = document.getElementById("toast");
const statPill = document.getElementById("stat-pill");
const notificationPanel = document.getElementById("notification-panel");
const notificationCount = document.getElementById("notification-count");
const notificationUnreadList = document.getElementById("notification-unread");
const notificationReadList = document.getElementById("notification-read");
const notificationHideBtn = document.getElementById("notification-hide");
const signupLink = document.getElementById("signup-link");
const moderatorLink = document.getElementById("moderator-link");
const adminLink = document.getElementById("admin-link");
const liveStatus = document.getElementById("live-status");
const seasonRemaining = document.getElementById("season-remaining");
const seasonStarPrice = document.getElementById("season-star-price");
const seasonCoins = document.getElementById("season-coins");
const seasonEmission = document.getElementById("season-emission");
const seasonTitle = document.getElementById("season-title");
const seasonStatus = document.getElementById("season-status");
const heroSeasonId = document.getElementById("hero-season-id");
const heroSeasonRemaining = document.getElementById("hero-season-remaining");
const heroStarPrice = document.getElementById("hero-star-price");
const leaderboardResults = document.getElementById("leaderboard-results");
const leaderboardPageLabel = document.getElementById("leaderboard-page");

const views = Array.from(document.querySelectorAll(".view"));
const viewMap = {
	home: "view-home",
	about: "view-about",
	playtest: "view-playtest",
	leaderboard: "view-leaderboard",
	signup: "view-signup",
	reset: "view-reset",
	admin: "view-admin",
	"admin-bots": "view-admin-bots",
	"admin-economy": "view-admin-economy",
	"admin-telemetry": "view-admin-telemetry",
	"admin-star-log": "view-admin-star-log",
	moderator: "view-moderator"
};

let joinedSeasonId = localStorage.getItem("joinedSeasonId");
let playerCoins = 0;
let playerStars = 0;
let currentUser = null;
let homeInitialized = false;
let adminInitialized = false;
let adminBotsInitialized = false;
let adminEconomyInitialized = false;
let adminTelemetryInitialized = false;
let adminStarLogInitialized = false;
let moderatorInitialized = false;
let signupInitialized = false;
let resetInitialized = false;
let leaderboardInitialized = false;
let playerRefreshInterval = null;
let seasonRefreshInterval = null;
let notificationRefreshInterval = null;
let activityPingInterval = null;
let starLogRefreshInterval = null;
let liveEventSource = null;
const ALPHA_SEASON_ID = "season-1";
let lastStarLogRows = [];
let leaderboardPage = 1;

if (joinedSeasonId && joinedSeasonId !== ALPHA_SEASON_ID) {
	localStorage.removeItem("joinedSeasonId");
	joinedSeasonId = null;
}

function apiFetch(url, options = {}) {
	return fetch(url, {
		...options,
		headers: {
			"Content-Type": "application/json",
			...(options.headers || {})
		},
		credentials: "include"
	});
}

async function track(eventType, payload) {
	try {
		await apiFetch("/telemetry", {
			method: "POST",
			body: JSON.stringify({ eventType, payload })
		});
	} catch (e) {}
}

function formatRemaining(seconds) {
	if (seconds <= 0) return "Ended";
	const days = Math.floor(seconds / 86400);
	const hours = Math.floor((seconds % 86400) / 3600);
	const minutes = Math.floor((seconds % 3600) / 60);
	if (days > 0) return `${days}d ${hours}h`;
	if (hours > 0) return `${hours}h ${minutes}m`;
	return `${minutes}m`;
}

function updateLiveStatus(state, message) {
	if (!liveStatus) return;
	liveStatus.classList.remove("offline", "reconnecting");
	if (state === "offline") {
		liveStatus.classList.add("offline");
		liveStatus.innerText = message || "Offline";
		return;
	}
	if (state === "reconnecting") {
		liveStatus.classList.add("reconnecting");
		liveStatus.innerText = message || "Reconnecting";
		return;
	}
	liveStatus.innerText = message || "Live updates";
}

function updateSeasonSnapshot(season) {
	if (!season) return;
	if (seasonTitle) seasonTitle.innerText = "Season 1";
	if (seasonRemaining) seasonRemaining.innerText = formatRemaining(season.secondsRemaining || 0);
	if (seasonStarPrice) seasonStarPrice.innerText = `${season.currentStarPrice} coins`;
	if (seasonCoins) seasonCoins.innerText = `${season.coinsInCirculation} coins`;
	if (seasonEmission) seasonEmission.innerText = `${(season.coinEmissionPerMinute || 0).toFixed(2)} / min`;
	if (heroSeasonId) heroSeasonId.innerText = "Season 1";
	if (heroSeasonRemaining) heroSeasonRemaining.innerText = formatRemaining(season.secondsRemaining || 0);
	if (heroStarPrice) heroStarPrice.innerText = `${season.currentStarPrice} coins`;
	if (seasonStatus) {
		seasonStatus.innerText = season.secondsRemaining > 0 ? "Active" : "Ended";
	}
}

function updateSeasonCard(season) {
	if (!season) return;
	const card = document.querySelector(`[data-season-id="${season.seasonId}"]`);
	if (!card) return;
	const remainingEl = card.querySelector("[data-season-remaining]");
	const priceEl = card.querySelector("[data-season-price]");
	const coinsEl = card.querySelector("[data-season-coins]");
	const emissionEl = card.querySelector("[data-season-emission]");
	if (remainingEl) remainingEl.innerText = formatRemaining(season.secondsRemaining || 0);
	if (priceEl) priceEl.innerText = `${season.currentStarPrice} coins`;
	if (coinsEl) coinsEl.innerText = `${season.coinsInCirculation} coins`;
	if (emissionEl) emissionEl.innerText = `${(season.coinEmissionPerMinute || 0).toFixed(2)} / min`;
}

function applyLiveSnapshot(payload) {
	if (!payload || !payload.season) return;
	updateSeasonSnapshot(payload.season);
	updateSeasonCard(payload.season);
	if (payload.authenticated && typeof payload.playerCoins === "number" && typeof payload.playerStars === "number") {
		playerCoins = payload.playerCoins;
		playerStars = payload.playerStars;
		coinsDiv.innerText = `Coins: ${playerCoins}`;
		starsDiv.innerText = `Stars: ${playerStars}`;
		statPill.innerText = `${playerCoins} coins · ${playerStars} stars`;
	}
}

function connectLiveStream() {
	if (liveEventSource) return;
	try {
		liveEventSource = new EventSource("/events");
		liveEventSource.addEventListener("snapshot", (event) => {
			try {
				const payload = JSON.parse(event.data);
				applyLiveSnapshot(payload);
				updateLiveStatus("live", "Live updates");
			} catch (e) {}
		});
		liveEventSource.onopen = () => updateLiveStatus("live", "Live updates");
		liveEventSource.onerror = () => updateLiveStatus("reconnecting", "Reconnecting");
	} catch (e) {
		updateLiveStatus("offline", "Offline");
	}
}

function disconnectLiveStream() {
	if (liveEventSource) {
		liveEventSource.close();
		liveEventSource = null;
	}
	updateLiveStatus("offline", "Offline");
}

function bindRangeValue(rangeId, outputId, formatter) {
	const input = document.getElementById(rangeId);
	const output = document.getElementById(outputId);
	if (!input || !output) return;
	const update = () => {
		const value = parseFloat(input.value);
		output.innerText = formatter ? formatter(value) : `${value}`;
	};
	input.addEventListener("input", update);
	update();
}

function bindRangeToggle(rangeId, outputId, toggleId, formatter) {
	const input = document.getElementById(rangeId);
	const output = document.getElementById(outputId);
	const toggle = document.getElementById(toggleId);
	if (!input || !output || !toggle) return;
	const update = () => {
		const value = parseFloat(input.value);
		output.innerText = formatter ? formatter(value) : `${value}`;
	};
	const updateState = () => {
		input.disabled = !toggle.checked;
		output.style.opacity = toggle.checked ? "1" : "0.5";
	};
	input.addEventListener("input", update);
	toggle.addEventListener("change", updateState);
	update();
	updateState();
}

function setRangeValue(rangeId, value) {
	const input = document.getElementById(rangeId);
	if (!input || value === undefined || value === null || Number.isNaN(value)) return;
	input.value = value;
	input.dispatchEvent(new Event("input"));
}

function bindToggleSelect(toggleId, selectId) {
	const toggle = document.getElementById(toggleId);
	const select = document.getElementById(selectId);
	if (!toggle || !select) return;
	const update = () => {
		select.disabled = !toggle.checked;
	};
	toggle.addEventListener("change", update);
	update();
}

async function loadAuth() {
	const res = await apiFetch("/auth/me");
	const data = await res.json();
	if (!data.ok) {
		currentUser = null;
		authStatus.innerText = "Log in to save your profile.";
		authForms.style.display = "block";
		logoutBtn.style.display = "none";
		playerPanels.style.display = "none";
		seasonSnapshot.style.display = "none";
		actionsCard.style.display = "none";
		whitelistRequestCard.style.display = "none";
		statPill.style.display = "none";
		signupLink.style.display = "inline";
		moderatorLink.style.display = "none";
		adminLink.style.display = "none";
		notificationPanel.style.display = "none";
		notificationUnreadList.innerHTML = "";
		notificationReadList.innerHTML = "";
		notificationCount.style.display = "none";
		document.getElementById("seasons").style.display = "none";
		document.getElementById("locked-message").innerText = "Log in to access seasons.";
		connectLiveStream();
		return;
	}

	currentUser = data;
	authStatus.innerText = `Logged in as ${data.displayName}`;
	authForms.style.display = "none";
	logoutBtn.style.display = "block";
	profileName.innerText = `@${data.username}`;
	profileRole.innerText = `Role: ${data.role || "user"}`;
	profileDisplay.value = data.displayName;
	await loadProfile();
	playerPanels.style.display = "grid";
	seasonSnapshot.style.display = "block";
	actionsCard.style.display = "block";
	whitelistRequestCard.style.display = "block";
	statPill.style.display = "inline-flex";
	signupLink.style.display = "none";
	moderatorLink.style.display = (data.isModerator || data.isAdmin) ? "inline" : "none";
	adminLink.style.display = data.isAdmin ? "inline" : "none";
	document.getElementById("seasons").style.display = "grid";
	document.getElementById("locked-message").innerText = "";
}

notificationHideBtn.addEventListener("click", () => {
	notificationPanel.style.display = "none";
});

async function pingActivity() {
	if (!currentUser) return;
	try {
		await apiFetch("/activity", { method: "POST", body: JSON.stringify({}) });
	} catch (e) {}
}

function startActiveLoops() {
	if (playerRefreshInterval || seasonRefreshInterval || notificationRefreshInterval || activityPingInterval) {
		return;
	}
	refreshPlayer();
	loadSeasons();
	refreshNotifications();
	pingActivity();
	connectLiveStream();
	playerRefreshInterval = setInterval(() => {
		if (currentUser) refreshPlayer();
	}, 10000);
	seasonRefreshInterval = setInterval(() => {
		if (currentUser) loadSeasons();
	}, 15000);
	notificationRefreshInterval = setInterval(() => {
		if (currentUser) refreshNotifications();
	}, 15000);
	activityPingInterval = setInterval(() => {
		if (currentUser) pingActivity();
	}, 20000);
}

function stopActiveLoops() {
	if (playerRefreshInterval) clearInterval(playerRefreshInterval);
	if (seasonRefreshInterval) clearInterval(seasonRefreshInterval);
	if (notificationRefreshInterval) clearInterval(notificationRefreshInterval);
	if (activityPingInterval) clearInterval(activityPingInterval);
	playerRefreshInterval = null;
	seasonRefreshInterval = null;
	notificationRefreshInterval = null;
	activityPingInterval = null;
	disconnectLiveStream();
}

function handleVisibility() {
	if (document.hidden) {
		stopActiveLoops();
		return;
	}
	if (currentUser) {
		startActiveLoops();
	}
}

async function refreshPlayer() {
	if (!currentUser) return;
	const res = await apiFetch("/player");
	if (res.status === 401) return;
	const data = await res.json();
	playerCoins = data.playerCoins || 0;
	playerStars = data.playerStars || 0;
	coinsDiv.innerText = `Coins: ${playerCoins}`;
	starsDiv.innerText = `Stars: ${playerStars}`;
	statPill.innerText = `${playerCoins} coins · ${playerStars} stars`;
}

async function loadProfile() {
	if (!currentUser) return;
	const res = await apiFetch("/profile");
	if (!res.ok) return;
	const data = await res.json();
	if (!data.ok) return;
	profileDisplay.value = data.displayName || "";
	profileEmail.value = data.email || "";
	profilePronouns.value = data.pronouns || "";
	profileLocation.value = data.location || "";
	profileWebsite.value = data.website || "";
	profileAvatar.value = data.avatarUrl || "";
	profileBio.value = data.bio || "";
	profileAvatarImg.src = data.avatarUrl || "https://placehold.co/64x64?text=User";
}

async function loadSeasons() {
	const res = await fetch("/seasons");
	const data = await res.json();
	const container = document.getElementById("seasons");
	container.innerHTML = "";
	const alphaSeason = data.seasons.find(season => season.seasonId === ALPHA_SEASON_ID);
	if (!alphaSeason) {
		container.innerHTML = "<div class='card'>Season unavailable.</div>";
		return;
	}

	[alphaSeason].forEach(season => {
		const div = document.createElement("div");
		const isJoined = joinedSeasonId !== null;
		const isThisSeasonJoined = season.seasonId === joinedSeasonId;
		const starPrice = season.currentStarPrice;
		updateSeasonSnapshot(season);

		div.className = "card season-card";
		div.dataset.seasonId = season.seasonId;
		if (isJoined && !isThisSeasonJoined) {
			div.style.opacity = "0.5";
		}
		if (season.seasonId === data.recommendedSeasonId) {
			div.classList.add("recommended");
		}

		div.innerHTML = `
			<div class="season-card-header">
				<div>
					<div class="label">Season 1</div>
					<div class="stat-value"><span data-season-remaining>${formatRemaining(season.secondsRemaining)}</span> remaining</div>
				</div>
				${season.seasonId === data.recommendedSeasonId ? '<span class="badge accent">Recommended</span>' : ''}
			</div>
			<div class="season-card-grid">
				<div class="metric">
					<div class="label">Star price</div>
					<div class="stat-value" data-season-price>${starPrice} coins</div>
				</div>
				<div class="metric">
					<div class="label">Coins in circulation</div>
					<div class="stat-value" data-season-coins>${season.coinsInCirculation} coins</div>
				</div>
				<div class="metric">
					<div class="label">Emission / min</div>
					<div class="stat-value" data-season-emission>${(season.coinEmissionPerMinute || 0).toFixed(2)} / min</div>
				</div>
			</div>
			<div class="season-actions">
				${isThisSeasonJoined
					? `<button class="buy-star-btn primary">Buy Star</button>`
					: isJoined
						? "<div class='label'>Locked to another season</div>"
						: "<button class='join-btn primary'>Join this season</button>"
				}
			</div>
		`;

		const buyButton = div.querySelector(".buy-star-btn");
		if (buyButton) {
			buyButton.addEventListener("click", async () => {
				const res = await apiFetch("/buy-star", {
					method: "POST",
					body: JSON.stringify({ seasonId: season.seasonId })
				});
				const data = await res.json();
				if (!data.ok) {
					setToast(data.error || "Purchase failed", "error");
					return;
				}
				playerCoins = data.playerCoins;
				playerStars = data.playerStars;
				coinsDiv.innerText = `Coins: ${playerCoins}`;
				starsDiv.innerText = `Stars: ${playerStars}`;
				statPill.innerText = `${playerCoins} coins · ${playerStars} stars`;
				setToast("Star purchased.", "success");
				track("buy_star", { seasonId: season.seasonId, price: data.starPricePaid });
			});
		}

		const button = div.querySelector(".join-btn");
		if (button) {
			button.addEventListener("click", () => {
				localStorage.setItem("joinedSeasonId", season.seasonId);
				track("join_season", { seasonId: season.seasonId });
				location.reload();
			});
		}

		container.appendChild(div);
	});
}

function setToast(message, type) {
	toast.innerText = message;
	toast.className = `toast ${type || ""}`;
	toast.style.display = "block";
	setTimeout(() => {
		toast.style.display = "none";
	}, 2500);
}

function initLeaderboard() {
	leaderboardInitialized = true;
	document.getElementById("leaderboard-apply").addEventListener("click", () => {
		leaderboardPage = 1;
		loadLeaderboard();
	});
	document.getElementById("leaderboard-prev").addEventListener("click", () => {
		if (leaderboardPage > 1) {
			leaderboardPage -= 1;
			loadLeaderboard();
		}
	});
	document.getElementById("leaderboard-next").addEventListener("click", () => {
		leaderboardPage += 1;
		loadLeaderboard();
	});
	document.getElementById("leaderboard-search").addEventListener("keydown", (event) => {
		if (event.key === "Enter") {
			leaderboardPage = 1;
			loadLeaderboard();
		}
	});
}

async function loadLeaderboard() {
	if (!leaderboardResults) return;
	const params = new URLSearchParams();
	const searchValue = document.getElementById("leaderboard-search").value.trim();
	const includeBots = document.getElementById("leaderboard-include-bots").checked;
	const botOnly = document.getElementById("leaderboard-bot-only").checked;
	const sort = document.getElementById("leaderboard-sort").value;
	const pageSize = parseInt(document.getElementById("leaderboard-page-size").value, 10) || 50;

	if (searchValue) params.set("q", searchValue);
	params.set("includeBots", includeBots ? "true" : "false");
	params.set("botOnly", botOnly ? "true" : "false");
	params.set("sort", sort);
	params.set("page", `${leaderboardPage}`);
	params.set("pageSize", `${pageSize}`);

	const res = await apiFetch(`/leaderboard?${params.toString()}`);
	const data = await res.json();
	if (!data.results) {
		leaderboardResults.innerHTML = "<div class='card'>Unable to load leaderboard.</div>";
		return;
	}

	if (data.results.length === 0) {
		leaderboardResults.innerHTML = "<div class='card'>No results found.</div>";
		if (leaderboardPageLabel) leaderboardPageLabel.innerText = `Page ${data.page} of 1`;
		return;
	}

	const totalPages = Math.max(1, Math.ceil((data.total || 0) / data.pageSize));
	if (leaderboardPageLabel) leaderboardPageLabel.innerText = `Page ${data.page} of ${totalPages}`;

	leaderboardResults.innerHTML = data.results.map(entry => {
		const botBadge = entry.isBot ? `<span class="badge bot">BOT</span>` : "";
		const botProfile = entry.isBot && entry.botProfile ? `<div class="label">${entry.botProfile}</div>` : "";
		const lastStar = entry.lastStarAcquiredAt ? new Date(entry.lastStarAcquiredAt).toLocaleString() : "-";
		return `
			<div class="card">
				<div class="row" style="justify-content:space-between;">
					<div><strong>#${entry.rank}</strong> ${entry.displayName}</div>
					${botBadge}
				</div>
				<div class="label">Stars ${entry.stars} · Coins spent ${entry.coinsSpentLifetime}</div>
				<div class="label">Last star: ${lastStar}</div>
				${botProfile}
			</div>
		`;
	}).join("");
}

async function refreshNotifications() {
	if (!currentUser) {
		notificationPanel.style.display = "none";
		notificationUnreadList.innerHTML = "";
		notificationReadList.innerHTML = "";
		notificationCount.style.display = "none";
		return;
	}
	const res = await apiFetch("/notifications");
	const data = await res.json();
	if (!data.ok) {
		notificationPanel.style.display = "none";
		return;
	}
	const items = data.notifications || [];
	const unread = items.filter(item => !item.isRead);
	const read = items.filter(item => item.isRead);
	if (items.length === 0) {
		notificationPanel.style.display = "none";
		notificationUnreadList.innerHTML = "";
		notificationReadList.innerHTML = "";
		notificationCount.style.display = "none";
		return;
	}
	notificationPanel.style.display = "block";
	if (unread.length > 0) {
		notificationCount.style.display = "inline-flex";
		notificationCount.innerText = `${unread.length} unread`;
	} else {
		notificationCount.style.display = "none";
	}

	const renderItem = (item) => {
		const level = item.level || "info";
		const stateClass = item.isRead ? "read" : "unread";
		const safeLink = item.link || "#/home";
		return `
			<div class="notice clickable ${level} ${stateClass}" data-id="${item.id}" data-link="${safeLink}" data-read="${item.isRead}">
				<div>${item.message}</div>
				<div class="label">${new Date(item.createdAt).toLocaleString()}</div>
			</div>
		`;
	};

	notificationUnreadList.innerHTML = unread.length > 0
		? unread.map(renderItem).join("")
		: "<div class='label'>No unread notifications.</div>";
	notificationReadList.innerHTML = read.length > 0
		? read.map(renderItem).join("")
		: "<div class='label'>No read notifications.</div>";

	[...notificationPanel.querySelectorAll(".notice[data-id]")].forEach(item => {
		item.addEventListener("click", async () => {
			const id = parseInt(item.getAttribute("data-id"), 10);
			const link = item.getAttribute("data-link") || "#/home";
			const isRead = item.getAttribute("data-read") === "true";
			if (!isRead) {
				await apiFetch("/notifications/ack", {
					method: "POST",
					body: JSON.stringify({ ids: [id] })
				});
				await refreshNotifications();
			}
			if (link.startsWith("http")) {
				window.location.href = link;
				return;
			}
			if (link.startsWith("#/")) {
				location.hash = link;
				return;
			}
			if (link.startsWith("/")) {
				location.hash = `#${link}`;
				return;
			}
			location.hash = `#/${link}`;
		});
	});
}

function setView(viewId) {
	views.forEach(view => view.classList.remove("active"));
	const nextView = document.getElementById(viewId);
	if (nextView) {
		nextView.classList.add("active");
	}
}

function initCollapsibleCards() {
	if (initCollapsibleCards.initialized) return;
	initCollapsibleCards.initialized = true;
	const cards = Array.from(document.querySelectorAll(".card[data-collapsible='true']"));
	cards.forEach(card => {
		const toggleBtn = card.querySelector(".toggle-btn");
		const body = card.querySelector(".card-body");
		if (!toggleBtn || !body) return;
		toggleBtn.addEventListener("click", () => {
			const collapsed = card.classList.toggle("collapsed");
			toggleBtn.innerText = collapsed ? "Show" : "Hide";
		});
	});
}

function getRouteInfo() {
	const hash = location.hash.replace("#", "");
	if (!hash || hash === "/") {
		return { routeKey: "home", query: new URLSearchParams() };
	}
	const trimmed = hash.startsWith("/") ? hash.slice(1) : hash;
	const parts = trimmed.split("?");
	const routeKey = viewMap[parts[0]] ? parts[0] : "home";
	const query = new URLSearchParams(parts[1] || "");
	return { routeKey, query };
}

async function route() {
	const { routeKey, query } = getRouteInfo();
	if (routeKey !== "admin-star-log") {
		stopStarLogRefresh();
	}
	await loadAuth();
	initCollapsibleCards();
	if (routeKey === "signup" && currentUser) {
		location.hash = "#/home";
		return;
	}
	setView(viewMap[routeKey]);
	if (routeKey === "home") {
		if (!homeInitialized) initHome();
		await refreshPlayer();
		if (currentUser && !document.hidden) {
			startActiveLoops();
		}
		return;
	}
	if (routeKey === "signup") {
		if (!signupInitialized) initSignup();
		return;
	}
	if (routeKey === "reset") {
		if (!resetInitialized) initReset();
		const token = query.get("token") || "";
		if (token) {
			document.getElementById("reset-token").value = token;
		}
		return;
	}
	if (routeKey === "admin") {
		if (!adminInitialized) initAdmin();
		await refreshAdminView();
		return;
	}
	if (routeKey === "admin-bots") {
		if (!adminBotsInitialized) initAdminBots();
		await refreshAdminBotsView();
		return;
	}
	if (routeKey === "admin-economy") {
		if (!adminEconomyInitialized) initAdminEconomy();
		await refreshAdminEconomyView();
		return;
	}
	if (routeKey === "admin-telemetry") {
		if (!adminTelemetryInitialized) initAdminTelemetry();
		await refreshAdminTelemetryView();
		return;
	}
	if (routeKey === "admin-star-log") {
		if (!adminStarLogInitialized) initAdminStarLog();
		await refreshAdminStarLogView();
		return;
	}
	if (routeKey === "moderator") {
		if (!moderatorInitialized) initModerator();
		await refreshModeratorView();
		return;
	}
	if (routeKey === "leaderboard") {
		if (!leaderboardInitialized) initLeaderboard();
		await loadLeaderboard();
		return;
	}
	stopStarLogRefresh();
}

function initHome() {
	homeInitialized = true;
	document.getElementById("login-btn").addEventListener("click", async () => {
		const username = document.getElementById("username").value;
		const password = document.getElementById("password").value;
		if (!username || !password) {
			setToast("Enter username and password.", "error");
			return;
		}
		setToast("Logging in...", "success");
		try {
			const res = await apiFetch("/auth/login", {
				method: "POST",
				body: JSON.stringify({ username, password })
			});
			let data = null;
			try {
				data = await res.json();
			} catch (e) {
				setToast("Login failed (invalid response)", "error");
				return;
			}
			if (!data.ok) {
				setToast(data.error || "Login failed", "error");
				return;
			}
			await loadAuth();
			if (!currentUser) {
				setToast("Login failed (session not established)", "error");
				return;
			}
			await refreshPlayer();
			await loadSeasons();
			setToast("Logged in.", "success");
			if (!document.hidden) {
				startActiveLoops();
			}
			track("login", {});
		} catch (e) {
			setToast("Login failed (network error)", "error");
		}
	});

	logoutBtn.addEventListener("click", async () => {
		await apiFetch("/auth/logout", { method: "POST" });
		currentUser = null;
		stopActiveLoops();
		await loadAuth();
	});

	profileSave.addEventListener("click", async () => {
		const displayName = profileDisplay.value;
		const email = profileEmail.value;
		const res = await apiFetch("/profile", {
			method: "POST",
			body: JSON.stringify({
				displayName,
				email,
				bio: profileBio.value,
				pronouns: profilePronouns.value,
				location: profileLocation.value,
				website: profileWebsite.value,
				avatarUrl: profileAvatar.value
			})
		});
		const data = await res.json();
		if (!data.ok) {
			setToast(data.error || "Update failed", "error");
			return;
		}
		authStatus.innerText = `Logged in as ${data.displayName}`;
		if (profileAvatar.value.trim()) {
			profileAvatarImg.src = profileAvatar.value.trim();
		}
		setToast("Profile updated.", "success");
	});

	document.getElementById("claim-daily").addEventListener("click", async () => {
		const res = await apiFetch("/claim-daily", { method: "POST", body: JSON.stringify({}) });
		const data = await res.json();
		if (!data.ok) {
			actionsStatus.innerText = data.error || "Claim failed";
			setToast(actionsStatus.innerText, "error");
			return;
		}
		actionsStatus.innerText = `Daily claim: +${data.reward} coins`;
		setToast("Daily claim received.", "success");
		await refreshPlayer();
	});

	document.getElementById("claim-activity").addEventListener("click", async () => {
		const res = await apiFetch("/claim-activity", { method: "POST", body: JSON.stringify({}) });
		const data = await res.json();
		if (!data.ok) {
			actionsStatus.innerText = data.error || "Claim failed";
			setToast(actionsStatus.innerText, "error");
			return;
		}
		actionsStatus.innerText = `Activity claim: +${data.reward} coins`;
		setToast("Activity claim received.", "success");
		await refreshPlayer();
	});

	document.getElementById("whitelist-request-btn").addEventListener("click", async () => {
		const reason = document.getElementById("whitelist-reason").value.trim();
		const res = await apiFetch("/auth/request-whitelist", {
			method: "POST",
			body: JSON.stringify({ reason })
		});
		const data = await res.json();
		document.getElementById("whitelist-request-status").innerText = data.ok
			? "Request submitted for admin review."
			: (data.error || "Request failed");
	});

	document.getElementById("dismiss-hint").addEventListener("click", () => {
		localStorage.setItem("dismissedHint", "true");
		onboarding.style.display = "none";
	});

	if (localStorage.getItem("dismissedHint") !== "true") {
		onboarding.style.display = "block";
	}

	document.addEventListener("visibilitychange", handleVisibility);
	handleVisibility();
}

function initSignup() {
	signupInitialized = true;
	document.getElementById("signup-btn").addEventListener("click", async () => {
		const username = document.getElementById("signup-username").value;
		const password = document.getElementById("signup-password").value;
		const displayName = document.getElementById("signup-display-name").value;
		const email = document.getElementById("signup-email").value;
		const res = await apiFetch("/auth/signup", {
			method: "POST",
			body: JSON.stringify({ username, password, displayName, email })
		});
		const data = await res.json();
		const toast = document.getElementById("signup-toast");
		if (!data.ok) {
			toast.innerText = data.error || "Signup failed";
			toast.style.display = "block";
			return;
		}
		location.hash = "#/home";
	});
}

function initReset() {
	resetInitialized = true;
	document.getElementById("reset-request-btn").addEventListener("click", async () => {
		const identifier = document.getElementById("reset-identifier").value.trim();
		const res = await apiFetch("/auth/request-reset", {
			method: "POST",
			body: JSON.stringify({ identifier })
		});
		const data = await res.json();
		const status = document.getElementById("reset-request-status");
		status.innerText = data.ok ? "If the account exists, a reset email was sent." : (data.error || "Request failed");
	});

	document.getElementById("reset-confirm-btn").addEventListener("click", async () => {
		const token = document.getElementById("reset-token").value.trim();
		const newPassword = document.getElementById("reset-new-password").value;
		const res = await apiFetch("/auth/reset-password", {
			method: "POST",
			body: JSON.stringify({ token, newPassword })
		});
		const data = await res.json();
		const status = document.getElementById("reset-confirm-status");
		if (!data.ok) {
			status.innerText = data.error || "Reset failed";
			return;
		}
		status.innerText = "Password updated. You can log in now.";
		location.hash = "#/home";
	});
}

function initAdmin() {
	adminInitialized = true;
	bindRangeValue("gs-active-interval", "gs-active-interval-value", value => `${value}s`);
	bindRangeValue("gs-idle-interval", "gs-idle-interval-value", value => `${value}s`);
	bindRangeValue("gs-active-amount", "gs-active-amount-value", value => `${value} coins`);
	bindRangeValue("gs-idle-amount", "gs-idle-amount-value", value => `${value} coins`);
	bindRangeValue("gs-activity-window", "gs-activity-window-value", value => `${value}s`);
	bindRangeToggle("pc-set-coins", "pc-set-coins-value", "pc-set-coins-enabled", value => `${value} coins`);
	bindRangeToggle("pc-add-coins", "pc-add-coins-value", "pc-add-coins-enabled", value => `+${value} coins`);
	bindRangeToggle("pc-set-stars", "pc-set-stars-value", "pc-set-stars-enabled", value => `${value} stars`);
	bindRangeToggle("pc-add-stars", "pc-add-stars-value", "pc-add-stars-enabled", value => `+${value} stars`);
	bindRangeToggle("pc-drip-mult", "pc-drip-mult-value", "pc-drip-mult-enabled", value => `${value.toFixed(1)}x`);
	bindToggleSelect("pc-is-bot-enabled", "pc-is-bot");
	bindToggleSelect("pc-bot-profile-enabled", "pc-bot-profile");
	document.getElementById("refresh").addEventListener("click", () => {
		loadSummary();
	});

	document.getElementById("save-key").addEventListener("click", async () => {
		const setupKey = document.getElementById("admin-setup-key").value.trim();
		const res = await apiFetch("/admin/set-key", {
			method: "POST",
			headers: { "X-Admin-Setup": setupKey },
			body: JSON.stringify({})
		});
		const data = await res.json();
		if (!data.ok) {
			document.getElementById("key-status").innerText = data.error || "Setup failed.";
			return;
		}
		document.getElementById("key-status").innerText = "Admin enabled.";
		await refreshAdminView();
		loadSummary();
		loadWhitelistRequests();
	});

	document.getElementById("role-save").addEventListener("click", async () => {
		const username = document.getElementById("role-username").value.trim();
		const role = document.getElementById("role-value").value;
		const res = await apiFetch("/admin/role", {
			method: "POST",
			body: JSON.stringify({ username, role })
		});
		const data = await res.json();
		document.getElementById("role-status").innerText = data.ok ? "Role updated." : (data.error || "Role update failed.");
	});

	document.getElementById("ip-whitelist-save").addEventListener("click", async () => {
		const ip = document.getElementById("ip-whitelist-value").value.trim();
		const maxAccounts = 2;
		const res = await apiFetch("/admin/ip-whitelist", {
			method: "POST",
			body: JSON.stringify({ ip, maxAccounts, action: "set" })
		});
		const data = await res.json();
		document.getElementById("ip-whitelist-status").innerText = data.ok ? "IP whitelisted." : (data.error || "Update failed.");
	});

	document.getElementById("ip-whitelist-remove").addEventListener("click", async () => {
		const ip = document.getElementById("ip-whitelist-value").value.trim();
		const res = await apiFetch("/admin/ip-whitelist", {
			method: "POST",
			body: JSON.stringify({ ip, action: "remove" })
		});
		const data = await res.json();
		document.getElementById("ip-whitelist-status").innerText = data.ok ? "IP removed." : (data.error || "Update failed.");
	});


	document.getElementById("notify-send").addEventListener("click", async () => {
		const targetRole = document.getElementById("notify-target").value;
		const accountId = document.getElementById("notify-account").value.trim();
		const level = document.getElementById("notify-level").value;
		const expiresAt = document.getElementById("notify-expires").value.trim();
		const link = document.getElementById("notify-link").value.trim();
		const message = document.getElementById("notify-message").value.trim();
		const res = await apiFetch("/admin/notifications", {
			method: "POST",
			body: JSON.stringify({ targetRole, accountId, level, expiresAt, link, message })
		});
		const data = await res.json();
		document.getElementById("notify-status").innerText = data.ok ? "Notification sent." : (data.error || "Send failed.");
		if (data.ok) {
			document.getElementById("notify-message").value = "";
			document.getElementById("notify-link").value = "";
		}
	});

	document.getElementById("gs-load").addEventListener("click", async () => {
		const res = await apiFetch("/admin/settings");
		const data = await res.json();
		const status = document.getElementById("gs-status");
		if (!data.ok) {
			status.innerText = data.error || "Load failed.";
			return;
		}
		const s = data.settings || {};
		setRangeValue("gs-active-interval", s.activeDripIntervalSeconds);
		setRangeValue("gs-idle-interval", s.idleDripIntervalSeconds);
		setRangeValue("gs-active-amount", s.activeDripAmount);
		setRangeValue("gs-idle-amount", s.idleDripAmount);
		setRangeValue("gs-activity-window", s.activityWindowSeconds);
		document.getElementById("gs-drip-enabled").value = s.dripEnabled ? "true" : "false";
		status.innerText = "Settings loaded.";
	});

	document.getElementById("gs-save").addEventListener("click", async () => {
		const payload = {};
		const activeInterval = parseInt(document.getElementById("gs-active-interval").value, 10);
		const idleInterval = parseInt(document.getElementById("gs-idle-interval").value, 10);
		const activeAmount = parseInt(document.getElementById("gs-active-amount").value, 10);
		const idleAmount = parseInt(document.getElementById("gs-idle-amount").value, 10);
		const activityWindow = parseInt(document.getElementById("gs-activity-window").value, 10);
		const dripEnabled = document.getElementById("gs-drip-enabled").value;
		if (!Number.isNaN(activeInterval)) payload.activeDripIntervalSeconds = activeInterval;
		if (!Number.isNaN(idleInterval)) payload.idleDripIntervalSeconds = idleInterval;
		if (!Number.isNaN(activeAmount)) payload.activeDripAmount = activeAmount;
		if (!Number.isNaN(idleAmount)) payload.idleDripAmount = idleAmount;
		if (!Number.isNaN(activityWindow)) payload.activityWindowSeconds = activityWindow;
		if (dripEnabled === "true") payload.dripEnabled = true;
		if (dripEnabled === "false") payload.dripEnabled = false;
		const res = await apiFetch("/admin/settings", {
			method: "POST",
			body: JSON.stringify(payload)
		});
		const data = await res.json();
		document.getElementById("gs-status").innerText = data.ok ? "Settings saved." : (data.error || "Save failed.");
	});

	document.getElementById("pc-load").addEventListener("click", async () => {
		const username = document.getElementById("pc-username").value.trim();
		const playerId = document.getElementById("pc-player-id").value.trim();
		const res = await apiFetch("/admin/player-controls", {
			method: "POST",
			body: JSON.stringify({ username, playerId })
		});
		const data = await res.json();
		const status = document.getElementById("pc-status");
		if (!data.ok) {
			status.innerText = data.error || "Load failed.";
			return;
		}
		status.innerText = `Loaded ${data.playerId} · coins ${data.coins} · stars ${data.stars} · drip ${data.dripMultiplier} · paused ${data.dripPaused}`;
		document.getElementById("pc-player-id").value = data.playerId || playerId;
		setRangeValue("pc-set-coins", data.coins);
		setRangeValue("pc-set-stars", data.stars);
		setRangeValue("pc-drip-mult", data.dripMultiplier);
		document.getElementById("pc-is-bot").value = data.isBot ? "true" : "false";
		document.getElementById("pc-bot-profile").value = data.botProfile || "";
	});

	document.getElementById("pc-save").addEventListener("click", async () => {
		const username = document.getElementById("pc-username").value.trim();
		const playerId = document.getElementById("pc-player-id").value.trim();
		const setCoinsEnabled = document.getElementById("pc-set-coins-enabled").checked;
		const addCoinsEnabled = document.getElementById("pc-add-coins-enabled").checked;
		const setStarsEnabled = document.getElementById("pc-set-stars-enabled").checked;
		const addStarsEnabled = document.getElementById("pc-add-stars-enabled").checked;
		const dripMultEnabled = document.getElementById("pc-drip-mult-enabled").checked;
		const isBotEnabled = document.getElementById("pc-is-bot-enabled").checked;
		const botProfileEnabled = document.getElementById("pc-bot-profile-enabled").checked;
		const setCoins = parseInt(document.getElementById("pc-set-coins").value, 10);
		const addCoins = parseInt(document.getElementById("pc-add-coins").value, 10);
		const setStars = parseInt(document.getElementById("pc-set-stars").value, 10);
		const addStars = parseInt(document.getElementById("pc-add-stars").value, 10);
		const dripMultiplier = parseFloat(document.getElementById("pc-drip-mult").value);
		const isBotValue = document.getElementById("pc-is-bot").value;
		const botProfileValue = document.getElementById("pc-bot-profile").value;
		const dripPausedValue = document.getElementById("pc-drip-paused").value;
		const payload = { username, playerId };
		if (setCoinsEnabled && !Number.isNaN(setCoins)) payload.setCoins = setCoins;
		if (addCoinsEnabled && !Number.isNaN(addCoins)) payload.addCoins = addCoins;
		if (setStarsEnabled && !Number.isNaN(setStars)) payload.setStars = setStars;
		if (addStarsEnabled && !Number.isNaN(addStars)) payload.addStars = addStars;
		if (dripMultEnabled && !Number.isNaN(dripMultiplier)) payload.dripMultiplier = dripMultiplier;
		if (isBotEnabled && (isBotValue === "true" || isBotValue === "false")) payload.isBot = isBotValue === "true";
		if (botProfileEnabled) payload.botProfile = botProfileValue;
		if (dripPausedValue === "true") payload.dripPaused = true;
		if (dripPausedValue === "false") payload.dripPaused = false;

		const res = await apiFetch("/admin/player-controls", {
			method: "POST",
			body: JSON.stringify(payload)
		});
		const data = await res.json();
		const status = document.getElementById("pc-status");
		status.innerText = data.ok ? `Updated ${data.playerId} · coins ${data.coins} · stars ${data.stars} · drip ${data.dripMultiplier} · paused ${data.dripPaused}` : (data.error || "Update failed.");
	});

	document.getElementById("pc-touch").addEventListener("click", async () => {
		const username = document.getElementById("pc-username").value.trim();
		const playerId = document.getElementById("pc-player-id").value.trim();
		const res = await apiFetch("/admin/player-controls", {
			method: "POST",
			body: JSON.stringify({ username, playerId, touchActive: true })
		});
		const data = await res.json();
		const status = document.getElementById("pc-status");
		status.innerText = data.ok ? `Touched active for ${data.playerId}` : (data.error || "Touch failed.");
	});

	loadWhitelistRequests();
}

function initAdminBots() {
	adminBotsInitialized = true;
	bindRangeValue("bot-min-interval", "bot-min-interval-value", value => `${value}s`);
	bindRangeToggle("bot-set-coins", "bot-set-coins-value", "bot-set-coins-enabled", value => `${value} coins`);
	bindRangeToggle("bot-add-coins", "bot-add-coins-value", "bot-add-coins-enabled", value => `+${value} coins`);
	bindRangeToggle("bot-set-stars", "bot-set-stars-value", "bot-set-stars-enabled", value => `${value} stars`);
	bindRangeToggle("bot-add-stars", "bot-add-stars-value", "bot-add-stars-enabled", value => `+${value} stars`);
	bindRangeToggle("bot-drip-mult", "bot-drip-mult-value", "bot-drip-mult-enabled", value => `${value.toFixed(1)}x`);
	bindToggleSelect("bot-is-bot-enabled", "bot-is-bot");
	bindToggleSelect("bot-profile-enabled", "bot-profile");

	document.getElementById("bots-global-save").addEventListener("click", async () => {
		const payload = {
			botsEnabled: document.getElementById("bots-enabled-toggle").checked,
			botMinStarIntervalSeconds: parseInt(document.getElementById("bot-min-interval").value, 10)
		};
		const res = await apiFetch("/admin/settings", {
			method: "POST",
			body: JSON.stringify(payload)
		});
		const data = await res.json();
		const status = document.getElementById("bots-global-status");
		if (!data.ok) {
			status.innerText = data.error || "Save failed.";
			return;
		}
		status.innerText = "Bot settings saved.";
	});

	document.getElementById("bot-load").addEventListener("click", async () => {
		const playerId = document.getElementById("bot-select").value;
		if (!playerId) {
			document.getElementById("bot-status").innerText = "Select a bot.";
			return;
		}
		const res = await apiFetch("/admin/player-controls", {
			method: "POST",
			body: JSON.stringify({ playerId })
		});
		const data = await res.json();
		const status = document.getElementById("bot-status");
		if (!data.ok) {
			status.innerText = data.error || "Load failed.";
			return;
		}
		status.innerText = `Loaded ${data.playerId} · coins ${data.coins} · stars ${data.stars} · drip ${data.dripMultiplier} · paused ${data.dripPaused}`;
		setRangeValue("bot-set-coins", data.coins);
		setRangeValue("bot-set-stars", data.stars);
		setRangeValue("bot-add-coins", 0);
		setRangeValue("bot-add-stars", 0);
		setRangeValue("bot-drip-mult", data.dripMultiplier);
		document.getElementById("bot-is-bot").value = data.isBot ? "true" : "false";
		document.getElementById("bot-profile").value = data.botProfile || "";
		document.getElementById("bot-drip-paused").value = "";
	});

	document.getElementById("bot-touch").addEventListener("click", async () => {
		const playerId = document.getElementById("bot-select").value;
		if (!playerId) {
			document.getElementById("bot-status").innerText = "Select a bot.";
			return;
		}
		const res = await apiFetch("/admin/player-controls", {
			method: "POST",
			body: JSON.stringify({ playerId, touchActive: true })
		});
		const data = await res.json();
		const status = document.getElementById("bot-status");
		status.innerText = data.ok ? `Touched active for ${data.playerId}` : (data.error || "Touch failed.");
	});

	document.getElementById("bot-save").addEventListener("click", async () => {
		const playerId = document.getElementById("bot-select").value;
		if (!playerId) {
			document.getElementById("bot-status").innerText = "Select a bot.";
			return;
		}
		const setCoinsEnabled = document.getElementById("bot-set-coins-enabled").checked;
		const addCoinsEnabled = document.getElementById("bot-add-coins-enabled").checked;
		const setStarsEnabled = document.getElementById("bot-set-stars-enabled").checked;
		const addStarsEnabled = document.getElementById("bot-add-stars-enabled").checked;
		const dripMultEnabled = document.getElementById("bot-drip-mult-enabled").checked;
		const isBotEnabled = document.getElementById("bot-is-bot-enabled").checked;
		const botProfileEnabled = document.getElementById("bot-profile-enabled").checked;
		const setCoins = parseInt(document.getElementById("bot-set-coins").value, 10);
		const addCoins = parseInt(document.getElementById("bot-add-coins").value, 10);
		const setStars = parseInt(document.getElementById("bot-set-stars").value, 10);
		const addStars = parseInt(document.getElementById("bot-add-stars").value, 10);
		const dripMultiplier = parseFloat(document.getElementById("bot-drip-mult").value);
		const isBotValue = document.getElementById("bot-is-bot").value;
		const botProfileValue = document.getElementById("bot-profile").value;
		const dripPausedValue = document.getElementById("bot-drip-paused").value;
		const payload = { playerId };
		if (setCoinsEnabled && !Number.isNaN(setCoins)) payload.setCoins = setCoins;
		if (addCoinsEnabled && !Number.isNaN(addCoins)) payload.addCoins = addCoins;
		if (setStarsEnabled && !Number.isNaN(setStars)) payload.setStars = setStars;
		if (addStarsEnabled && !Number.isNaN(addStars)) payload.addStars = addStars;
		if (dripMultEnabled && !Number.isNaN(dripMultiplier)) payload.dripMultiplier = dripMultiplier;
		if (isBotEnabled && (isBotValue === "true" || isBotValue === "false")) payload.isBot = isBotValue === "true";
		if (botProfileEnabled) payload.botProfile = botProfileValue;
		if (dripPausedValue === "true") payload.dripPaused = true;
		if (dripPausedValue === "false") payload.dripPaused = false;

		const res = await apiFetch("/admin/player-controls", {
			method: "POST",
			body: JSON.stringify(payload)
		});
		const data = await res.json();
		const status = document.getElementById("bot-status");
		status.innerText = data.ok ? `Updated ${data.playerId} · coins ${data.coins} · stars ${data.stars} · drip ${data.dripMultiplier} · paused ${data.dripPaused}` : (data.error || "Update failed.");
	});
}

async function refreshAdminBotsView() {
	const res = await apiFetch("/auth/me");
	const data = await res.json();
	if (!data.ok || !data.isAdmin) {
		document.getElementById("bots-no-access").style.display = "block";
		document.getElementById("bots-global").style.display = "none";
		document.getElementById("bots-individual").style.display = "none";
		return false;
	}
	document.getElementById("bots-no-access").style.display = "none";
	document.getElementById("bots-global").style.display = "block";
	document.getElementById("bots-individual").style.display = "block";
	await loadBotSettings();
	await loadBotList();
	return true;
}

async function loadBotSettings() {
	const res = await apiFetch("/admin/settings");
	const data = await res.json();
	const status = document.getElementById("bots-global-status");
	if (!data.ok) {
		status.innerText = data.error || "Load failed.";
		return;
	}
	const s = data.settings || {};
	if (typeof s.botsEnabled === "boolean") {
		document.getElementById("bots-enabled-toggle").checked = s.botsEnabled;
	}
	if (typeof s.botMinStarIntervalSeconds === "number") {
		setRangeValue("bot-min-interval", s.botMinStarIntervalSeconds);
	}
	status.innerText = "Bot settings loaded.";
}

async function loadBotList() {
	const res = await apiFetch("/admin/bots");
	const data = await res.json();
	const select = document.getElementById("bot-select");
	if (!data.ok) {
		select.innerHTML = "<option value=\"\">No bots available</option>";
		return;
	}
	const current = select.value;
	const bots = data.bots || [];
	if (bots.length === 0) {
		select.innerHTML = "<option value=\"\">No bots found</option>";
		return;
	}
	select.innerHTML = ["<option value=\"\">Select bot</option>", ...bots.map(bot => {
		const name = bot.displayName ? ` · ${bot.displayName}` : "";
		const label = `${bot.username || bot.playerId}${name}`;
		return `<option value=\"${bot.playerId}\">${label}</option>`;
	})].join("");
	if (current) {
		select.value = current;
	}
}

async function refreshAdminView() {
	const res = await apiFetch("/auth/me");
	const data = await res.json();
	if (!data.ok || !data.isAdmin) {
		document.getElementById("no-access").style.display = "block";
		document.getElementById("admin-content").style.display = "none";
		document.getElementById("role-management").style.display = "none";
		document.getElementById("ip-whitelist").style.display = "none";
		document.getElementById("whitelist-requests").style.display = "none";
		document.getElementById("admin-notify").style.display = "none";
		document.getElementById("admin-player-controls").style.display = "none";
		document.getElementById("admin-settings").style.display = "none";
		document.getElementById("admin-setup").style.display = "block";
		return false;
	}
	document.getElementById("no-access").style.display = "none";
	document.getElementById("admin-setup").style.display = "none";
	document.getElementById("admin-content").style.display = "block";
	document.getElementById("role-management").style.display = "block";
	document.getElementById("ip-whitelist").style.display = "block";
	document.getElementById("whitelist-requests").style.display = "block";
	document.getElementById("admin-notify").style.display = "block";
	document.getElementById("admin-player-controls").style.display = "block";
	document.getElementById("admin-settings").style.display = "block";
	loadWhitelistRequests();
	return true;
}

async function loadStarPurchaseLog() {
	const status = document.getElementById("star-log-status");
	const container = document.getElementById("star-log-list");
	const filterKey = document.getElementById("star-log-filter-key").value;
	const filterValue = document.getElementById("star-log-filter-value").value.trim();

	const params = new URLSearchParams();
	if (filterKey && filterValue) {
		if (filterKey === "limit") {
			const parsed = parseInt(filterValue, 10);
			if (!Number.isNaN(parsed)) {
				params.set("limit", parsed);
			}
		} else {
			params.set(filterKey, filterValue);
		}
	}

	const url = params.toString() ? `/admin/star-purchases?${params.toString()}` : "/admin/star-purchases";
	const res = await apiFetch(url);
	const data = await res.json();
	if (!data.ok) {
		status.innerText = data.error || "Load failed.";
		container.innerHTML = "";
		return;
	}

	const rows = data.items || [];
	lastStarLogRows = rows;
	status.innerText = `Loaded ${rows.length} entries.`;
	if (rows.length === 0) {
		container.innerText = "No results.";
		return;
	}
	container.innerHTML = rows.map(row => {
		const time = new Date(row.createdAt).toLocaleString();
		const variantLabel = row.variant ? ` · ${row.variant}` : "";
		return `
			<div class="card" style="margin-top:0.5rem;">
				<div class="label">${time} · ${row.seasonId}</div>
				<div>${row.purchaseType}${variantLabel} · paid ${row.pricePaid}</div>
				<div class="label">Account ${row.accountId} · Player ${row.playerId}</div>
				<div class="label">Coins ${row.coinsBefore} → ${row.coinsAfter} · Stars ${row.starsBefore} → ${row.starsAfter}</div>
			</div>
		`;
	}).join("");
}

async function exportStarPurchaseLog(format) {
	if (!lastStarLogRows || lastStarLogRows.length === 0) {
		await loadStarPurchaseLog();
	}
	const rows = lastStarLogRows || [];
	if (rows.length === 0) {
		setToast("No entries to export.", "error");
		return;
	}
	if (format === "json") {
		const blob = new Blob([JSON.stringify(rows, null, 2)], { type: "application/json" });
		triggerDownload(blob, "star-purchase-log.json");
		return;
	}
	const headers = [
		"id",
		"createdAt",
		"seasonId",
		"purchaseType",
		"variant",
		"accountId",
		"playerId",
		"pricePaid",
		"coinsBefore",
		"coinsAfter",
		"starsBefore",
		"starsAfter"
	];
	const csvLines = [headers.join(",")];
	rows.forEach(row => {
		const values = [
			row.id,
			new Date(row.createdAt).toISOString(),
			row.seasonId,
			row.purchaseType,
			row.variant || "",
			row.accountId,
			row.playerId,
			row.pricePaid,
			row.coinsBefore,
			row.coinsAfter,
			row.starsBefore,
			row.starsAfter
		].map(value => {
			const text = String(value ?? "");
			if (text.includes(",") || text.includes("\"")) {
				return `"${text.replace(/"/g, '""')}"`;
			}
			return text;
		});
		csvLines.push(values.join(","));
	});
	const blob = new Blob([csvLines.join("\n")], { type: "text/csv" });
	triggerDownload(blob, "star-purchase-log.csv");
}

function triggerDownload(blob, filename) {
	const url = URL.createObjectURL(blob);
	const link = document.createElement("a");
	link.href = url;
	link.download = filename;
	document.body.appendChild(link);
	link.click();
	document.body.removeChild(link);
	URL.revokeObjectURL(url);
}

async function loadWhitelistRequests() {
	const res = await apiFetch("/admin/whitelist-requests");
	const data = await res.json();
	const container = document.getElementById("whitelist-requests-list");
	if (!data.ok) {
		container.innerText = "Unable to load requests.";
		return;
	}
	const rows = data.requests || [];
	if (rows.length === 0) {
		container.innerText = "No pending requests.";
		return;
	}
	container.innerHTML = rows.map(req => {
		const time = new Date(req.createdAt).toLocaleString();
		return `
			<div class="card" style="margin-top:0.75rem;">
				<div class="label">${req.ip} · ${time}</div>
				<div class="label">Reason: ${req.reason || "(none)"}</div>
				<div class="row" style="margin-top:0.5rem;">
					<input data-max="${req.requestId}" placeholder="Max accounts" />
					<button data-approve="${req.requestId}" class="primary">Approve</button>
					<button data-deny="${req.requestId}">Deny</button>
				</div>
			</div>
		`;
	}).join("");

	container.querySelectorAll("button[data-approve]").forEach(btn => {
		btn.addEventListener("click", async () => {
			const requestId = btn.getAttribute("data-approve");
			const maxInput = container.querySelector(`input[data-max="${requestId}"]`);
			const maxAccounts = parseInt(maxInput.value, 10) || 2;
			await resolveWhitelistRequest(requestId, "approve", maxAccounts);
		});
	});

	container.querySelectorAll("button[data-deny]").forEach(btn => {
		btn.addEventListener("click", async () => {
			const requestId = btn.getAttribute("data-deny");
			await resolveWhitelistRequest(requestId, "deny", 0);
		});
	});
}

async function resolveWhitelistRequest(requestId, decision, maxAccounts) {
	const res = await apiFetch("/admin/whitelist-requests", {
		method: "POST",
		body: JSON.stringify({ requestId, decision, maxAccounts })
	});
	const data = await res.json();
	if (!data.ok) {
		document.getElementById("whitelist-requests-list").innerText = data.error || "Update failed.";
		return;
	}
	loadWhitelistRequests();
}

async function loadSummary() {
	const res = await fetch("/seasons");
	const data = await res.json();
	const season = data.seasons.find(s => s.seasonId === "season-1");
	if (!season) {
		document.getElementById("season-summary").innerText = "Season not found.";
		return;
	}
	const hoursLeft = Math.floor(season.secondsRemaining / 3600);
	document.getElementById("season-summary").innerText =
		`Season 1 · ${hoursLeft}h left · Coins in circulation: ${season.coinsInCirculation} · Star price: ${season.currentStarPrice}`;
}

function initAdminEconomy() {
	adminEconomyInitialized = true;
	document.getElementById("emission").addEventListener("input", (e) => {
		document.getElementById("emission-value").innerText = e.target.value;
	});

	document.getElementById("econ-save").addEventListener("click", async () => {
		const payload = {
			dailyEmissionTarget: parseInt(document.getElementById("emission").value, 10),
			faucetsEnabled: document.getElementById("faucets").checked,
			sinksEnabled: document.getElementById("sinks").checked,
			telemetryEnabled: document.getElementById("telemetry").checked
		};
		const res = await apiFetch("/admin/economy", {
			method: "POST",
			body: JSON.stringify(payload)
		});
		const data = await res.json();
		if (!data.ok) {
			document.getElementById("econ-status").innerText = data.error || "Save failed";
			return;
		}
		document.getElementById("econ-status").innerText = "Saved.";
		loadEconomy();
	});

	
}

async function refreshAdminEconomyView() {
	const res = await apiFetch("/auth/me");
	const data = await res.json();
	if (!data.ok || !data.isAdmin) {
		document.getElementById("econ-no-access").style.display = "block";
		return false;
	}
	document.getElementById("econ-no-access").style.display = "none";
	await loadEconomy();
	return true;
}

async function loadEconomy() {
	const res = await apiFetch("/admin/economy");
	const data = await res.json();
	if (!data.ok) {
		document.getElementById("econ-status").innerText = "Unauthorized.";
		return;
	}
	const emission = document.getElementById("emission");
	emission.value = data.dailyEmissionTarget || 0;
	document.getElementById("emission-value").innerText = emission.value;
	document.getElementById("faucets").checked = !!data.faucetsEnabled;
	document.getElementById("sinks").checked = !!data.sinksEnabled;
	document.getElementById("telemetry").checked = !!data.telemetryEnabled;
}

function initAdminTelemetry() {
	adminTelemetryInitialized = true;
}

function initAdminStarLog() {
	adminStarLogInitialized = true;
	document.getElementById("star-log-load").addEventListener("click", async () => {
		await loadStarPurchaseLog();
	});

	document.getElementById("star-log-clear").addEventListener("click", async () => {
		document.getElementById("star-log-filter-key").value = "";
		document.getElementById("star-log-filter-value").value = "";
		await loadStarPurchaseLog();
	});

	document.getElementById("star-log-export-csv").addEventListener("click", async () => {
		await exportStarPurchaseLog("csv");
	});

	document.getElementById("star-log-export-json").addEventListener("click", async () => {
		await exportStarPurchaseLog("json");
	});
}

async function refreshAdminTelemetryView() {
	const res = await apiFetch("/auth/me");
	const data = await res.json();
	if (!data.ok || !data.isAdmin) {
		document.getElementById("tele-no-access").style.display = "block";
		return false;
	}
	document.getElementById("tele-no-access").style.display = "none";
	await loadTelemetry();
	return true;
}

async function refreshAdminStarLogView() {
	const res = await apiFetch("/auth/me");
	const data = await res.json();
	if (!data.ok || !data.isAdmin) {
		document.getElementById("star-log-no-access").style.display = "block";
		document.getElementById("star-log-list").innerHTML = "";
		stopStarLogRefresh();
		return false;
	}
	document.getElementById("star-log-no-access").style.display = "none";
	await loadStarPurchaseLog();
	startStarLogRefresh();
	return true;
}

function startStarLogRefresh() {
	if (starLogRefreshInterval) return;
	starLogRefreshInterval = setInterval(() => {
		loadStarPurchaseLog();
	}, 10000);
}

function stopStarLogRefresh() {
	if (starLogRefreshInterval) {
		clearInterval(starLogRefreshInterval);
		starLogRefreshInterval = null;
	}
}

async function loadTelemetry() {
	const res = await apiFetch("/admin/telemetry");
	const data = await res.json();
	if (!data.ok) {
		document.getElementById("telemetry-body").innerHTML = "<tr><td colspan='3'>Unauthorized</td></tr>";
		return;
	}
	const rows = data.series || [];
	const tbody = document.getElementById("telemetry-body");
	tbody.innerHTML = rows.map(row => {
		const time = new Date(row.bucket).toLocaleString();
		return `<tr><td>${time}</td><td>${row.eventType}</td><td>${row.count}</td></tr>`;
	}).join("");

	
}

function initModerator() {
	moderatorInitialized = true;
	document.getElementById("mod-load-view").addEventListener("click", async () => {
		const username = document.getElementById("mod-username-view").value.trim();
		const res = await apiFetch(`/moderator/profile?username=${encodeURIComponent(username)}`);
		const data = await res.json();
		if (!data.ok) {
			document.getElementById("mod-status-view").innerText = data.error || "Load failed.";
			return;
		}
		document.getElementById("mod-display-name-view").value = data.displayName || "";
		document.getElementById("mod-email-view").value = data.email || "";
		document.getElementById("mod-pronouns-view").value = data.pronouns || "";
		document.getElementById("mod-location-view").value = data.location || "";
		document.getElementById("mod-website-view").value = data.website || "";
		document.getElementById("mod-avatar-view").value = data.avatarUrl || "";
		document.getElementById("mod-bio-view").value = data.bio || "";
		document.getElementById("mod-status-view").innerText = "Profile loaded.";
	});

	document.getElementById("mod-save-view").addEventListener("click", async () => {
		const username = document.getElementById("mod-username-view").value.trim();
		const displayName = document.getElementById("mod-display-name-view").value.trim();
		const email = document.getElementById("mod-email-view").value.trim();
		const pronouns = document.getElementById("mod-pronouns-view").value.trim();
		const location = document.getElementById("mod-location-view").value.trim();
		const website = document.getElementById("mod-website-view").value.trim();
		const avatarUrl = document.getElementById("mod-avatar-view").value.trim();
		const bio = document.getElementById("mod-bio-view").value.trim();
		const res = await apiFetch("/moderator/profile", {
			method: "POST",
			body: JSON.stringify({ username, displayName, email, pronouns, location, website, avatarUrl, bio })
		});
		const data = await res.json();
		document.getElementById("mod-status-view").innerText = data.ok ? "Profile updated." : (data.error || "Update failed.");
	});

}

async function refreshModeratorView() {
	const res = await apiFetch("/auth/me");
	const data = await res.json();
	if (!data.ok || (!data.isModerator && !data.isAdmin)) {
		document.getElementById("mod-no-access").style.display = "block";
		document.getElementById("moderator-content").style.display = "none";
		return false;
	}
	document.getElementById("mod-no-access").style.display = "none";
	document.getElementById("moderator-content").style.display = "block";
	return true;
}

window.addEventListener("error", (event) => {
	setToast(`Error: ${event.message}`, "error");
});

window.addEventListener("unhandledrejection", (event) => {
	setToast("Error: unexpected failure", "error");
});

window.addEventListener("hashchange", () => {
	route().catch((err) => {
		const message = err && err.message ? err.message : "route failed";
		setToast(`Error: ${message}`, "error");
	});
});

route().catch((err) => {
	const message = err && err.message ? err.message : "route failed";
	setToast(`Error: ${message}`, "error");
});
	</script>
</body>
</html>
