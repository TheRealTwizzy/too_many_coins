<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Too Many Coins — Admin</title>
	<style>
	body {
		font-family: system-ui, sans-serif;
		background: #0f1220;
		color: #eaeaf0;
		padding: 2rem;
		max-width: 960px;
		margin: 0 auto;
	}
	a { color: #c5cae9; text-decoration: none; }
	.card {
		border: 1px solid #2a2f55;
		padding: 1rem;
		margin-bottom: 1rem;
		border-radius: 10px;
		background: #141a2e;
	}
	.label { font-size: 0.8rem; color: #aaa; }
	.row { display: flex; gap: 1rem; flex-wrap: wrap; }
	button {
		background: #0f1220;
		border: 1px solid #2a2f55;
		color: #eaeaf0;
		padding: 0.5rem 0.75rem;
		border-radius: 8px;
		cursor: pointer;
	}
	button.primary { background: #3b82f6; border-color: #3b82f6; }
	</style>
</head>
<body>
	<h1>Admin</h1>
	<p class="label">Alpha 1 tools (admin only).</p>
	<p><a href="/">Back to game</a> · <a href="/admin-telemetry.html">Telemetry</a> · <a href="/admin-economy.html">Economy</a></p>

	<div class="card" id="admin-setup" style="display:none;">
		<div class="label">Admin setup</div>
		<input id="admin-setup-key" placeholder="Setup key" />
		<input id="admin-key" placeholder="Set admin key" />
		<button id="save-key" class="primary">Save</button>
		<div id="key-status" class="label"></div>
	</div>

	<div class="card" id="admin-content" style="display:none;">
		<div class="label">Season summary</div>
		<div id="season-summary">Loading…</div>
		<div class="row" style="margin-top:0.5rem;">
			<button id="refresh" class="primary">Refresh</button>
		</div>
	</div>

	<div class="card" id="role-management" style="display:none;">
		<div class="label">Role management</div>
		<div class="row" style="margin-top:0.5rem;">
			<input id="role-username" placeholder="Username" />
			<select id="role-value">
				<option value="moderator">Moderator</option>
				<option value="admin">Admin</option>
			</select>
			<button id="role-save" class="primary">Set role</button>
		</div>
		<div id="role-status" class="label"></div>
	</div>

	<div class="card" id="admin-key-management" style="display:none;">
		<div class="label">Set user admin key</div>
		<div class="row" style="margin-top:0.5rem;">
			<input id="user-key-username" placeholder="Username" />
			<input id="user-key-value" placeholder="New admin key" />
			<button id="user-key-save" class="primary">Save key</button>
		</div>
		<div id="user-key-status" class="label"></div>
	</div>

	<div class="card" id="moderator-profile" style="display:none;">
		<div class="label">Moderator: edit profile</div>
		<div class="row" style="margin-top:0.5rem;">
			<input id="mod-username" placeholder="Username" />
			<button id="mod-load" class="primary">Load</button>
		</div>
		<div class="row" style="margin-top:0.5rem;">
			<input id="mod-display-name" placeholder="Display name" />
			<button id="mod-save" class="primary">Update</button>
		</div>
		<div id="mod-status" class="label"></div>
	</div>

	<div class="card" id="auction-card" style="display:none;">
		<div class="label">Auction</div>
		<div id="auction-status">Loading…</div>
	</div>

	<div class="card" id="no-access" style="display:none;">
		<div class="label">Not authorized</div>
		<div class="label">You need an admin account to view this page.</div>
	</div>

	<script>
	function getAdminKey() {
		return localStorage.getItem("adminKey") || "";
	}

	async function apiFetch(url, options = {}) {
		return fetch(url, {
			...options,
			headers: {
				"Content-Type": "application/json",
				"X-Admin-Key": getAdminKey(),
				...(options.headers || {})
			},
			credentials: "include"
		});
	}

	async function loadAccess() {
		const res = await apiFetch("/auth/me");
		const data = await res.json();
		if (!data.ok || !data.isAdmin) {
			document.getElementById("no-access").style.display = "block";
			return false;
		}
		document.getElementById("admin-content").style.display = "block";
		document.getElementById("role-management").style.display = "block";
		document.getElementById("admin-key-management").style.display = "block";
		document.getElementById("moderator-profile").style.display = "block";
		document.getElementById("auction-card").style.display = "block";
		return true;
	}

	async function loadSummary() {
		const res = await fetch("/seasons");
		const data = await res.json();
		const season = data.seasons.find(s => s.seasonId === "season-1");
		if (!season) {
			document.getElementById("season-summary").innerText = "Season not found.";
			return;
		}
		const hoursLeft = Math.floor(season.secondsRemaining / 3600);
		document.getElementById("season-summary").innerText =
			`Season 1 · ${hoursLeft}h left · Coins in circulation: ${season.coinsInCirculation} · Star price: ${season.currentStarPrice}`;
	}

	async function loadAuction() {
		const res = await apiFetch("/auction-status");
		const data = await res.json();
		if (!data.ok || !data.status) {
			document.getElementById("auction-status").innerText = "Auction unavailable.";
			return;
		}
		const endsAt = new Date(data.status.endsAt).toLocaleString();
		document.getElementById("auction-status").innerText =
			`${data.status.itemKey} · min ${data.status.minBid} · current ${data.status.currentBid} · ends ${endsAt}`;
	}

	document.getElementById("refresh").addEventListener("click", () => {
		loadSummary();
		loadAuction();
	});

	document.getElementById("save-key").addEventListener("click", async () => {
		const setupKey = document.getElementById("admin-setup-key").value.trim();
		const key = document.getElementById("admin-key").value.trim();
		const res = await apiFetch("/admin/set-key", {
			method: "POST",
			headers: { "X-Admin-Setup": setupKey },
			body: JSON.stringify({ adminKey: key })
		});
		const data = await res.json();
		if (!data.ok) {
			document.getElementById("key-status").innerText = data.error || "Setup failed.";
			return;
		}
		localStorage.setItem("adminKey", key);
		document.getElementById("key-status").innerText = "Admin key set.";
		await loadAccess();
		loadSummary();
		loadAuction();
	});

	document.getElementById("role-save").addEventListener("click", async () => {
		const username = document.getElementById("role-username").value.trim();
		const role = document.getElementById("role-value").value;
		const res = await apiFetch("/admin/role", {
			method: "POST",
			body: JSON.stringify({ username, role })
		});
		const data = await res.json();
		document.getElementById("role-status").innerText = data.ok ? "Role updated." : (data.error || "Role update failed.");
	});

	document.getElementById("user-key-save").addEventListener("click", async () => {
		const username = document.getElementById("user-key-username").value.trim();
		const adminKey = document.getElementById("user-key-value").value.trim();
		const res = await apiFetch("/admin/set-user-key", {
			method: "POST",
			body: JSON.stringify({ username, adminKey })
		});
		const data = await res.json();
		document.getElementById("user-key-status").innerText = data.ok ? "Admin key updated." : (data.error || "Key update failed.");
	});

	document.getElementById("mod-load").addEventListener("click", async () => {
		const username = document.getElementById("mod-username").value.trim();
		const res = await apiFetch(`/moderator/profile?username=${encodeURIComponent(username)}`);
		const data = await res.json();
		if (!data.ok) {
			document.getElementById("mod-status").innerText = data.error || "Load failed.";
			return;
		}
		document.getElementById("mod-display-name").value = data.displayName || "";
		document.getElementById("mod-status").innerText = "Profile loaded.";
	});

	document.getElementById("mod-save").addEventListener("click", async () => {
		const username = document.getElementById("mod-username").value.trim();
		const displayName = document.getElementById("mod-display-name").value.trim();
		const res = await apiFetch("/moderator/profile", {
			method: "POST",
			body: JSON.stringify({ username, displayName })
		});
		const data = await res.json();
		document.getElementById("mod-status").innerText = data.ok ? "Profile updated." : (data.error || "Update failed.");
	});

	const storedKey = getAdminKey();
	if (storedKey) {
		document.getElementById("admin-key").value = storedKey;
		document.getElementById("key-status").innerText = "Key loaded.";
	}

	loadAccess().then((ok) => {
		if (ok) {
			loadSummary();
			loadAuction();
		} else {
			document.getElementById("admin-setup").style.display = "block";
		}
	});
	</script>
</body>
</html>
